# PR#17.1: In-App Toast Notifications

**Estimated Time:** 2-3 hours  
**Complexity:** MEDIUM  
**Dependencies:** PR #10 (Real-Time Messaging), PR #12 (Presence)

---

## Overview

### What We're Building

**In-app Toast notifications that alert users when they receive messages in conversations they're not currently viewing.**

When a user is in Conversation A and receives a message in Conversation B:
- ✅ Toast banner slides down from top of screen
- ✅ Shows sender name, message preview, and profile picture
- ✅ Auto-dismisses after 4 seconds or user can swipe up to dismiss
- ✅ Tap toast → Navigates to that conversation
- ✅ Smooth animations (slide in/out)
- ✅ Works immediately - no APNs, no Apple Developer account needed!

### Why This Matters

**This is a practical MVP alternative to push notifications.**

Without any notifications:
- User has to check every conversation manually
- Misses messages while chatting with someone else
- No way to know when friends message them
- Poor multi-conversation experience

With in-app toast notifications:
- Instant awareness of new messages in other chats
- Can quickly switch conversations by tapping toast
- Professional messaging app feel
- Works in simulator and on device
- **No Apple Developer account required!**

### Success in One Sentence

"This PR is successful when a user chatting with Alice sees a toast notification slide down showing 'Bob: Hey, are you there?' and can tap it to jump to Bob's conversation."

---

## Technical Design

### Architecture Decisions

#### Decision 1: Toast vs Modal vs Badge-Only

**Options Considered:**

1. **Option A: Toast notification (banner at top)**
   - Pros: Non-intrusive, auto-dismisses, industry standard (Slack, Discord)
   - Cons: Can be missed if user not paying attention
   - UX: Slides from top, stays 4 seconds, dismissible

2. **Option B: Modal/Alert popup**
   - Pros: Impossible to miss, forces acknowledgment
   - Cons: Very intrusive, interrupts current activity
   - UX: Blocks screen, requires tap to dismiss

3. **Option C: Badge-only (no toast)**
   - Pros: Least intrusive
   - Cons: Easy to miss, no preview, poor UX
   - UX: Just shows number on tab bar

**Chosen:** Option A - Toast notification

**Rationale:**
- **Balance:** Visible but not intrusive
- **Industry standard:** Slack, Discord, Telegram all use toast
- **User-friendly:** Auto-dismisses so doesn't block UI
- **Informative:** Shows sender + message preview + profile picture
- **Actionable:** Tap to navigate directly to conversation

**Trade-offs:**
- Gain: Non-intrusive, smooth UX, doesn't interrupt workflow
- Lose: Can be missed if user not looking (acceptable for in-app)

---

#### Decision 2: Toast Position and Duration

**Options Considered:**

1. **Option A: Top of screen (below status bar)**
   - Duration: 4 seconds
   - Animation: Slide from top
   - Pros: Natural iOS pattern, doesn't block content
   - Cons: Can be obscured by navigation bar

2. **Option B: Bottom of screen (above tab bar)**
   - Duration: 4 seconds
   - Animation: Slide from bottom
   - Pros: Doesn't conflict with navigation
   - Cons: Blocks input area, less standard

3. **Option C: Center overlay**
   - Duration: 2 seconds
   - Animation: Fade in/out
   - Pros: Impossible to miss
   - Cons: Very intrusive, blocks all content

**Chosen:** Option A - Top of screen, 4 seconds

**Rationale:**
- iOS native pattern (notifications slide from top)
- Familiar to users (matches system notifications)
- 4 seconds is enough to read (name + message preview)
- Doesn't interfere with typing or bottom UI
- Can be dismissed early by swipe up

**Trade-offs:**
- Gain: Familiar UX, non-blocking, readable duration
- Lose: May need to accommodate safe area insets

---

#### Decision 3: When to Show Toast

**Options Considered:**

1. **Option A: Show only when in different conversation**
   - Trigger: User in Chat A, message arrives in Chat B
   - Don't show: User in Chat B, message arrives in Chat B
   - Logic: `activeConversationId != message.conversationId`

2. **Option B: Show for ALL messages (even current chat)**
   - Trigger: Any new message arrives
   - Always show toast
   - Logic: Show everything

3. **Option C: Show only when app is backgrounded**
   - Trigger: App not in foreground
   - Don't show: App is active
   - Logic: Requires app state tracking

**Chosen:** Option A - Only when in different conversation

**Rationale:**
- **No spam:** User already sees messages in current chat (real-time listener)
- **Focused:** Only notifies about OTHER conversations
- **Efficient:** Reduces unnecessary UI updates
- **Expected behavior:** Matches push notification logic

**Implementation:**
```swift
// In ToastNotificationManager
func shouldShowToast(for message: Message) -> Bool {
    guard let activeConversationId = activeConversationId else {
        // Not in any chat, could show but we'll skip (on chat list)
        return false
    }
    
    // Only show if message is from a DIFFERENT conversation
    return message.conversationId != activeConversationId
}
```

**Trade-offs:**
- Gain: No notification spam, respects user focus
- Lose: None (this is the right behavior)

---

#### Decision 4: Toast Content and Style

**Content to Display:**

**Chosen Format:**
```
┌─────────────────────────────────────────────┐
│ 👤 [Profile Pic]  Alice                     │
│                    Hey, are you there?      │
└─────────────────────────────────────────────┘
```

**Elements:**
- Profile picture (or initials fallback)
- Sender display name
- Message text (truncated to 50 chars)
- OR "📷 Image" if image message

**Style:**
- Background: Blur effect (iOS native frosted glass)
- Text: Primary color (sender name bold), Secondary (message preview)
- Shadow: Subtle drop shadow for depth
- Padding: 16px vertical, 12px horizontal
- Corner radius: 16px (rounded rectangle)
- Height: ~70px (fixed height)

**Rationale:**
- Professional appearance (matches iOS native notifications)
- Clear sender identification (profile pic + name)
- Readable message preview (50 chars is ~one line)
- Touch-friendly (70px height is easy to tap)

---

### System Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                      App Layer (SwiftUI)                      │
│                                                               │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ChatView (Conversation A - Active)                  │     │
│  │  - User is chatting with Alice                      │     │
│  │  - activeConversationId = "conv-alice-123"          │     │
│  └────────────────────────────────────────────────────┘     │
│                          ↓                                    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ToastNotificationView (Overlay)                     │     │
│  │  - Renders at top of screen                         │     │
│  │  - Z-index: High (above all content)                │     │
│  │  - Animation: Slide from top                        │     │
│  │  - Auto-dismiss: 4 seconds                          │     │
│  │  - Tap gesture: Navigate to conversation            │     │
│  └────────────────────────────────────────────────────┘     │
│                          ↑                                    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ToastNotificationManager (ObservableObject)         │     │
│  │  - @Published currentToast: ToastMessage?           │     │
│  │  - showToast(message) - Display toast               │     │
│  │  - dismissToast() - Hide toast                      │     │
│  │  - activeConversationId: String? - Track active     │     │
│  │  - messageQueue: [ToastMessage] - Queue handling    │     │
│  └────────────────────────────────────────────────────┘     │
│                          ↑                                    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ ChatViewModel / ChatListViewModel                   │     │
│  │  - Observes new messages via Firestore listener     │     │
│  │  - Checks: Should show toast?                       │     │
│  │  - Calls: ToastNotificationManager.showToast()      │     │
│  └────────────────────────────────────────────────────┘     │
│                          ↑                                    │
│  ┌────────────────────────────────────────────────────┐     │
│  │ Firestore Real-Time Listener (PR #10)               │     │
│  │  - New message arrives from Bob (Conversation B)    │     │
│  │  - Message: "Hey, are you there?"                   │     │
│  │  - Triggers: ChatListViewModel update               │     │
│  └────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
```

**Flow:**
1. User is in ChatView with Alice (Conversation A)
2. Bob sends message in Conversation B
3. Firestore real-time listener detects new message
4. ChatListViewModel receives update
5. Checks: `message.conversationId != activeConversationId`
6. Calls: `ToastNotificationManager.shared.showToast()`
7. ToastNotificationView appears with slide animation
8. Toast displays for 4 seconds, then auto-dismisses
9. User can tap toast → Navigate to Bob's conversation

---

### Data Model

#### ToastMessage (New)

**File:** `Models/ToastMessage.swift`

```swift
import Foundation

struct ToastMessage: Identifiable, Equatable {
    let id: String // messageId
    let conversationId: String
    let senderId: String
    let senderName: String
    let senderPhotoURL: String?
    let messageText: String?
    let isImageMessage: Bool
    let timestamp: Date
    
    // Computed
    var displayText: String {
        if let text = messageText {
            // Truncate to 50 characters
            if text.count > 50 {
                return String(text.prefix(50)) + "..."
            }
            return text
        } else if isImageMessage {
            return "📷 Image"
        } else {
            return "New message"
        }
    }
    
    // Initialize from Message + Sender User
    init(message: Message, sender: User) {
        self.id = message.id
        self.conversationId = message.conversationId
        self.senderId = message.senderId
        self.senderName = sender.displayName
        self.senderPhotoURL = sender.photoURL
        self.messageText = message.text
        self.isImageMessage = message.imageURL != nil
        self.timestamp = message.createdAt
    }
}
```

---

### Service Architecture

#### ToastNotificationManager (New)

**File:** `Services/ToastNotificationManager.swift`

**Responsibilities:**
- Manage toast display state
- Track active conversation (to prevent self-notifications)
- Queue toasts if multiple arrive simultaneously
- Auto-dismiss after duration
- Handle navigation on tap

**Key Properties:**
```swift
@MainActor
class ToastNotificationManager: ObservableObject {
    static let shared = ToastNotificationManager()
    
    // Published state
    @Published var currentToast: ToastMessage?
    @Published var isShowingToast: Bool = false
    
    // Configuration
    let toastDuration: TimeInterval = 4.0
    
    // Active conversation tracking
    var activeConversationId: String?
    
    // Queue for multiple toasts
    private var toastQueue: [ToastMessage] = []
    
    // Timer for auto-dismiss
    private var dismissTimer: Task<Void, Never>?
}
```

**Key Methods:**
```swift
// Show a toast notification
func showToast(_ toast: ToastMessage)

// Dismiss current toast
func dismissToast()

// Check if should show toast for message
func shouldShowToast(conversationId: String) -> Bool

// Navigate to conversation from toast tap
func handleToastTap(conversationId: String)

// Process queued toasts
private func processNextToast()
```

---

## Implementation Details

### File Structure

**New Files:**
```
messAI/
├── Models/
│   └── ToastMessage.swift                  (~80 lines) - Toast data model
├── Services/
│   └── ToastNotificationManager.swift      (~200 lines) - Toast management
└── Views/
    └── Components/
        └── ToastNotificationView.swift     (~250 lines) - Toast UI component
```

**Modified Files:**
```
messAI/
├── messAIApp.swift                         (+20 lines) - Add toast overlay
├── ViewModels/
│   ├── ChatListViewModel.swift             (+30 lines) - Trigger toasts
│   └── ChatViewModel.swift                 (+15 lines) - Track active conversation
└── Views/
    └── Chat/
        └── ChatView.swift                  (+10 lines) - Set activeConversationId
```

**Total:** 3 new files (~530 lines), 4 modified files (+75 lines)

---

### Key Implementation Steps

#### Phase 1: Data Model & Manager (1 hour)

**1. Create ToastMessage Model**
- Define struct with all required fields
- Add computed properties (displayText, truncation)
- Implement Identifiable and Equatable

**2. Create ToastNotificationManager**
- Singleton pattern with ObservableObject
- Published properties for SwiftUI binding
- Toast queue management
- Auto-dismiss timer logic
- Active conversation tracking

---

#### Phase 2: Toast UI Component (1 hour)

**1. Create ToastNotificationView**
- SwiftUI view with slide animation
- Profile picture + name + message layout
- Blur background effect (iOS native)
- Tap gesture for navigation
- Swipe up to dismiss gesture
- Safe area handling

**2. Animation Design**
```swift
// Slide in from top
.offset(y: isShowing ? 0 : -200)
.animation(.spring(response: 0.4, dampingFraction: 0.7), value: isShowing)

// Auto-dismiss after 4 seconds
.onAppear {
    Task {
        try? await Task.sleep(nanoseconds: 4_000_000_000) // 4 seconds
        withAnimation {
            dismissToast()
        }
    }
}
```

---

#### Phase 3: Integration (30 minutes)

**1. Update messAIApp.swift**
- Add ToastNotificationView as overlay
- Inject ToastNotificationManager into environment

**2. Update ChatListViewModel**
- Listen for new messages
- Check if should show toast
- Trigger toast display

**3. Update ChatView**
- Set activeConversationId on appear
- Clear on disappear

---

#### Phase 4: Navigation Handling (30 minutes)

**1. Deep Link from Toast**
- Post NotificationCenter event
- ChatListView listens for event
- Navigate to conversation

**2. Dismiss on Navigation**
- Auto-dismiss toast when navigating
- Clear toast state

---

## Testing Strategy

### Test Categories

#### Unit Tests (4 tests)

**ToastMessage Tests:**
1. Display text truncates at 50 characters
2. Image messages show "📷 Image"
3. Empty messages show "New message"

**ToastNotificationManager Tests:**
4. shouldShowToast returns false for active conversation
5. shouldShowToast returns true for different conversation

---

#### Integration Tests (6 tests)

**Toast Display:**
1. Toast appears when message arrives in different conversation
2. Toast does NOT appear when message in active conversation
3. Toast auto-dismisses after 4 seconds
4. Multiple toasts queue properly (show one at a time)

**Toast Navigation:**
5. Tap toast navigates to conversation
6. Swipe up dismisses toast

---

#### UI/UX Tests (5 tests)

**Animation:**
1. Toast slides smoothly from top (spring animation)
2. Toast slides up when dismissed

**Appearance:**
3. Profile picture displays correctly (or initials fallback)
4. Sender name is bold
5. Message preview is readable (secondary color)

**Safe Area:**
6. Toast respects safe area (doesn't overlap status bar)
7. Toast readable on all screen sizes

---

#### Edge Cases (4 tests)

1. Toast while already showing toast (queue handling)
2. Navigate away while toast showing (auto-dismiss)
3. Receive 10 messages rapidly (queue all, show sequentially)
4. Long sender name + long message (truncation works)

---

## Success Criteria

### Feature Complete When:

- [x] **ToastMessage model created**
  - Truncation works correctly
  - Image messages handled
  - Equatable implemented

- [x] **ToastNotificationManager working**
  - Singleton accessible
  - Toast queue managed
  - Auto-dismiss after 4 seconds
  - Active conversation tracked

- [x] **ToastNotificationView rendering**
  - Slides from top smoothly
  - Blur background effect
  - Profile picture + name + message
  - Tap gesture navigates
  - Swipe up dismisses

- [x] **Integration complete**
  - Toasts triggered from ChatListViewModel
  - Active conversation tracked in ChatView
  - Navigation works from toast tap
  - No toasts for active conversation

- [x] **All tests pass**
  - 4 unit tests passing
  - 6 integration tests passing
  - 5 UI/UX tests passing
  - 4 edge case tests passing

---

### Performance Targets

| Metric | Target | Critical |
|--------|--------|----------|
| Toast animation duration | ~400ms | ⚠️ Preferred |
| Toast display time | 4 seconds | ✅ Yes |
| Toast queue processing | <100ms | ⚠️ Preferred |
| Memory per toast | <1KB | ℹ️ Monitor |
| Multiple toasts (10+) | No lag | ✅ Yes |

---

### Quality Gates

**Before Merging:**
- ✅ Toasts appear for messages in other conversations
- ✅ No toasts for messages in active conversation
- ✅ Animation smooth and polished
- ✅ Tap navigation works reliably
- ✅ Auto-dismiss timing accurate (4 seconds)
- ✅ Queue handles multiple toasts gracefully
- ✅ No memory leaks or retained toasts
- ✅ Code compiles without errors or warnings

---

## Risk Assessment

### Risk 1: Toast Missed by User 🟡 MEDIUM

**Issue:** User may not notice toast if not looking at screen

**Likelihood:** MEDIUM  
**Impact:** MEDIUM (user misses notification)

**Mitigation:**
- Toast duration: 4 seconds (long enough to notice)
- Slide animation draws eye
- Sound/haptic feedback (optional enhancement)
- Badge count on chat list remains as fallback

**Contingency:**
- If users report missing toasts, increase duration to 5-6 seconds
- Add subtle sound effect (optional)
- Add vibration on toast appear (optional)

**Status:** 🟢 Acceptable for in-app notifications

---

### Risk 2: Toast Spam (Multiple Messages) 🟡 MEDIUM

**Issue:** Receiving many messages quickly could spam toasts

**Likelihood:** LOW (most conversations are sequential)  
**Impact:** MEDIUM (annoying UX)

**Mitigation:**
- Queue system: Only one toast visible at a time
- Subsequent toasts wait for previous to dismiss
- Max queue size: 5 toasts (drop oldest if exceeded)

**Contingency:**
- If spam becomes an issue:
  - Group toasts: "3 new messages from Bob"
  - Cooldown: Max 1 toast per conversation per 10 seconds

**Status:** 🟡 Monitored, mitigated

---

### Risk 3: Toast Obscures Important UI 🟢 LOW

**Issue:** Toast at top might block navigation bar or important content

**Likelihood:** LOW (positioned above content)  
**Impact:** LOW (temporary, auto-dismisses)

**Mitigation:**
- Toast positioned in safe area (below status bar)
- Doesn't block navigation buttons
- User can swipe to dismiss immediately
- Semi-transparent background (blur effect)

**Status:** 🟢 Design prevents issue

---

## Open Questions

### Question 1: Sound/Haptic Feedback?

**Question:** Should toast appearance include sound or vibration?

**Options:**
- A: No sound/vibration (visual only)
- B: Subtle sound (like iOS notification "ding")
- C: Haptic feedback (light tap)
- D: Both sound + haptic

**Decision Needed By:** Implementation (Phase 2)

**Recommendation:** **Option A for MVP** - Visual only. Can add sound/haptic in polish phase (PR #20) based on user feedback.

---

### Question 2: Toast for Group Messages?

**Question:** Show toast differently for group messages?

**Options:**
- A: Same format: "Alice: Message text"
- B: Include group name: "Test Group - Alice: Message text"
- C: Different icon/indicator for groups

**Decision Needed By:** Implementation (Phase 1)

**Recommendation:** **Option B** - Include group name for context. User knows which group the message is from.

---

## Timeline

### Total Estimate: 2-3 hours

| Phase | Tasks | Time | Status |
|-------|-------|------|--------|
| **Phase 1: Model & Manager** | ToastMessage, ToastNotificationManager | 1h | ⏳ |
| **Phase 2: UI Component** | ToastNotificationView with animations | 1h | ⏳ |
| **Phase 3: Integration** | Wire into app, trigger from ViewModel | 30m | ⏳ |
| **Phase 4: Navigation** | Deep link from tap, dismiss handling | 30m | ⏳ |
| **TOTAL** | | **2-3h** | |

---

## Dependencies

### Requires (Must be complete first):

- ✅ **PR #10: Real-Time Messaging**
  - Real-time Firestore listener
  - Messages arriving in real-time

- ✅ **PR #7: Chat List View**
  - ChatListViewModel exists
  - Conversation list management

- ✅ **PR #9: Chat View**
  - ChatView exists
  - Active conversation tracking possible

### Blocks (Cannot start until this is done):

- None! This is a self-contained feature

---

## Comparison: PR#17.1 vs PR#17

### What's Different

| Feature | PR#17.1 (In-App) | PR#17 (Push) |
|---------|------------------|--------------|
| **Scope** | App must be open | Works when app closed |
| **Visibility** | Only when using app | Lock screen + app |
| **Setup** | No credentials needed | Apple Developer required |
| **Testing** | Simulator works ✅ | Physical device only |
| **Implementation** | 2-3 hours | 3-4 hours |
| **Badge** | In-app only | OS-level badge |
| **Sound** | Optional | OS notification sound |

### What's the Same

| Feature | Both |
|---------|------|
| **Content** | Sender name + message preview |
| **Navigation** | Tap → Open conversation |
| **Smart** | No self-notifications |
| **Queue** | Handle multiple messages |

---

## Future: Upgrade Path to PR#17

When Apple Developer account is available:

**PR#17.1 (In-App)** provides the foundation:
- ✅ Toast UI component (reusable)
- ✅ ToastNotificationManager (logic reusable)
- ✅ Active conversation tracking
- ✅ Navigation from notification tap

**PR#17 (Push)** adds on top:
- APNs integration
- Cloud Functions
- Background delivery
- Badge count

**Estimated upgrade time:** 2-3 hours (since foundation exists)

---

## Notes

### Why This Is a Great MVP Alternative

**Pros:**
- ✅ Works immediately (no Apple Developer account)
- ✅ Can test in simulator
- ✅ Provides core notification functionality
- ✅ Professional appearance (blur effect, animations)
- ✅ Non-intrusive UX
- ✅ Foundation for PR#17 later

**Cons:**
- ❌ Only works when app is open
- ❌ No lock screen notifications
- ❌ No badge count when app closed
- ❌ Users must have app in foreground

**Trade-off:** For MVP, this is acceptable. Most users will have the app open when actively messaging. This bridges the gap until Apple Developer account is ready.

---

### Testing Notes

**Simulator Works! ✅**
- Can test all functionality in iOS Simulator
- No physical device required
- No APNs credentials needed
- Fast iteration during development

**Easy to Test:**
1. Run app in simulator (Device A)
2. Run app in different simulator (Device B)
3. Send message from Device B
4. See toast on Device A
5. Tap toast, verify navigation

---

### User Experience

**Scenario:**
1. User opens app, starts chatting with Alice
2. Bob sends a message while user is chatting with Alice
3. Toast slides down from top: "Bob: Hey, are you there?"
4. User sees toast, decides to respond to Bob
5. Taps toast → Navigates to Bob's conversation
6. Replies to Bob
7. Returns to Alice's conversation

**Result:** Seamless multi-conversation experience without leaving the app!

---

**Status:** ✅ PLANNING COMPLETE  
**Next Step:** Implement Phase 1 (Model & Manager)  
**Estimated Total Time:** 2-3 hours  
**Complexity:** MEDIUM  
**Impact:** 🎯 MVP-quality notifications without Apple Developer account

---

*"The best solution is the one you can ship today."*

