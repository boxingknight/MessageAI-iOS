# PR#22.1: In-App Toast Notifications - Testing Guide

**Comprehensive test strategy for in-app toast notifications**

---

## Overview

This testing guide covers **19 comprehensive test scenarios** across 4 categories:
- Unit Tests (4 tests)
- Integration Tests (6 tests)
- UI/UX Tests (5 tests)
- Edge Cases (4 tests)

**Testing Philosophy:** Toast notifications are user-facing. Every scenario should pass before declaring complete.

**Time Required:** ~30-40 minutes for full test suite

---

## Test Environment Setup

### Required Equipment

**2 iOS Simulators (or 1 Simulator + 1 Device):**
- Simulator A: Primary testing (logged in as User A)
- Simulator B: Secondary testing (logged in as User B)

**Why This Works:**
- ✅ iOS Simulator fully supports in-app notifications
- ✅ No physical device needed
- ✅ No APNs credentials required
- ✅ Fast iteration and testing

**Configuration:**
- iOS 16.0+
- Logged into different user accounts
- At least 2 conversations created

---

### Test Data Setup (5 minutes)

#### Create Test Users

**User A (Primary Tester):**
```
Email: alice@test.com
Display Name: Alice Test
Password: testpass123
```

**User B (Secondary):**
```
Email: bob@test.com
Display Name: Bob Test
Password: testpass123
```

**User C (Third person):**
```
Email: charlie@test.com
Display Name: Charlie Test
Password: testpass123
```

#### Create Test Conversations

**1. Alice ↔ Bob** (one-on-one)
- 2-3 messages exchanged

**2. Alice ↔ Charlie** (one-on-one)
- 2-3 messages exchanged

**3. Group: Alice, Bob, Charlie** (optional for advanced testing)
- Group name: "Test Group"
- 2-3 messages

---

### Verification Tools

**1. Xcode Console**
```bash
# Filter logs
🔔 - Toast display
📍 - Active conversation tracking
📬 - Queue management
```

**2. Visual Inspection**
- Toast appearance (slides from top)
- Animation smoothness
- Content readability

**3. Interaction Testing**
- Tap response
- Swipe to dismiss
- Navigation accuracy

---

## Unit Tests (4 tests)

### Test 1: Display Text Truncation

**Objective:** Verify message preview truncates at 50 characters

**Setup:**
```swift
let longMessage = "This is a very long message that should definitely be truncated because it exceeds the fifty character limit"
let toast = ToastMessage(
    id: "test1",
    conversationId: "conv1",
    senderId: "user1",
    senderName: "Alice",
    senderPhotoURL: nil,
    messageText: longMessage,
    isImageMessage: false,
    timestamp: Date()
)
```

**Test:**
```swift
let displayText = toast.displayText
```

**Expected Results:**
- ✅ Display text is exactly 53 characters (50 + "...")
- ✅ Ends with "..."
- ✅ First 50 characters preserved
- ✅ Original message unchanged

**Verification:**
```swift
print("Length: \(displayText.count)") // Should be 53
print("Ends with ...: \(displayText.hasSuffix("..."))")  // true
```

**Pass Criteria:**
- Truncation at exactly 50 characters
- Ellipsis added
- Readable preview

---

### Test 2: Image Message Display

**Objective:** Verify image messages show "📷 Image"

**Setup:**
```swift
let imageMessage = ToastMessage(
    id: "test2",
    conversationId: "conv1",
    senderId: "user1",
    senderName: "Bob",
    senderPhotoURL: nil,
    messageText: nil,
    isImageMessage: true,
    timestamp: Date()
)
```

**Test:**
```swift
let displayText = imageMessage.displayText
```

**Expected Results:**
- ✅ Display text is "📷 Image"
- ✅ No message text shown
- ✅ Icon recognizable

**Pass Criteria:**
- Shows "📷 Image" exactly
- Works when messageText is nil

---

### Test 3: shouldShowToast for Active Conversation

**Objective:** Verify toast NOT shown for active conversation

**Setup:**
```swift
let manager = ToastNotificationManager.shared
manager.activeConversationId = "conv-alice-123"
```

**Test:**
```swift
let shouldShowForActive = manager.shouldShowToast(conversationId: "conv-alice-123")
let shouldShowForOther = manager.shouldShowToast(conversationId: "conv-bob-456")
```

**Expected Results:**
- ✅ shouldShowForActive = false (same conversation)
- ✅ shouldShowForOther = true (different conversation)

**Verification:**
```swift
print("Active conversation: \(shouldShowForActive)") // false
print("Other conversation: \(shouldShowForOther)")  // true
```

**Pass Criteria:**
- Returns false for active conversation
- Returns true for different conversation
- Returns false if no active conversation (on chat list)

---

### Test 4: Queue Management

**Objective:** Verify queue properly stores and processes toasts

**Setup:**
```swift
let manager = ToastNotificationManager.shared
manager.isShowingToast = true // Simulate toast already showing

let toast1 = createTestToast(id: "1", from: "Alice")
let toast2 = createTestToast(id: "2", from: "Bob")
let toast3 = createTestToast(id: "3", from: "Charlie")
```

**Test:**
```swift
manager.showToast(toast1)  // Should queue (already showing)
manager.showToast(toast2)  // Should queue
manager.showToast(toast3)  // Should queue
```

**Expected Results:**
- ✅ All 3 toasts added to queue
- ✅ Queue size = 3
- ✅ First toast still showing (not replaced)

**Verification:**
- Check queue count
- Verify order (FIFO)

**Pass Criteria:**
- Queue stores toasts correctly
- Max queue size respected (5 max)
- Oldest dropped if exceeds 5

---

## Integration Tests (6 tests)

### Test 5: Toast Appears for Different Conversation

**Objective:** End-to-end flow: message in different conversation triggers toast

**Setup:**
- Simulator A: User A logged in
- Simulator A: Open conversation with Bob (ChatView)
- Simulator B: User Charlie logged in

**Steps:**
1. Simulator A: Stay in Bob's conversation
2. Simulator B: Send message to Alice: "Hey Alice, quick question!"
3. Watch Simulator A

**Expected Results:**
- ✅ Toast appears within 1 second
- ✅ Toast slides down from top
- ✅ Shows "Charlie Test"
- ✅ Shows "Hey Alice, quick question!"
- ✅ Profile picture or initials visible

**Xcode Console:**
```
🔔 Showing toast: Charlie Test
📍 Active conversation: conv-bob-456
```

**Pass Criteria:**
- Toast appears promptly
- Content accurate
- Animation smooth

---

### Test 6: No Toast for Active Conversation

**Objective:** Verify NO toast when message arrives in active conversation

**Setup:**
- Simulator A: User A in conversation with Bob
- Simulator B: User Bob

**Steps:**
1. Simulator A: Stay in Bob's conversation (ChatView)
2. Simulator B (as Bob): Send message: "This should not show toast"
3. Watch Simulator A

**Expected Results:**
- ✅ NO toast appears
- ✅ Message appears via real-time listener in ChatView
- ✅ Message visible immediately in chat

**Xcode Console:**
```
📍 Active conversation: conv-bob-123
🤔 Should show? false (same conversation)
```

**Pass Criteria:**
- No toast displayed
- Message still appears in chat (real-time works)
- No double notification

---

### Test 7: Toast Auto-Dismisses After 4 Seconds

**Objective:** Verify exact timing of auto-dismiss

**Setup:**
- Trigger toast to appear
- Start stopwatch

**Steps:**
1. Cause toast to appear (message from different conversation)
2. Start stopwatch when toast appears
3. Do not interact with toast
4. Wait and watch

**Expected Results:**
- ✅ Toast displays for exactly 4 seconds (±0.2s tolerance)
- ✅ Toast slides up smoothly after 4s
- ✅ Toast disappears completely
- ✅ If queued toast exists, next one appears

**Timing:**
- Start: Toast appears
- End: Toast starts slide-up animation
- Duration: 4.0 seconds (±0.2s)

**Pass Criteria:**
- Auto-dismiss timing accurate
- Smooth animation
- Clean removal

---

### Test 8: Tap Toast Navigates to Conversation

**Objective:** Verify tapping toast opens correct conversation

**Setup:**
- Simulator A: User A in conversation with Bob
- Trigger toast from Charlie

**Steps:**
1. Toast appears: "Charlie: Hey Alice..."
2. Tap toast immediately (before auto-dismiss)
3. Observe navigation

**Expected Results:**
- ✅ Toast dismisses immediately on tap
- ✅ App navigates to Charlie's conversation
- ✅ ChatView opens with Charlie's messages
- ✅ Navigation time <500ms

**Xcode Console:**
```
👆 Toast tapped: Navigate to conv-charlie-789
📱 Opening conversation from toast: conv-charlie-789
```

**Pass Criteria:**
- Correct conversation opens
- Navigation instant (<500ms)
- Toast dismisses before navigation
- Messages visible in conversation

---

### Test 9: Swipe Up Dismisses Toast

**Objective:** Verify swipe gesture dismisses toast early

**Setup:**
- Trigger toast to appear

**Steps:**
1. Toast appears
2. Immediately swipe up on toast (before 4s)
3. Observe behavior

**Expected Results:**
- ✅ Toast dismisses immediately on swipe
- ✅ Doesn't wait for 4-second timer
- ✅ Smooth slide-up animation
- ✅ Next queued toast appears (if any)

**Gesture:**
- Start: Touch toast
- Move: Drag finger up ~100px
- Release: Lift finger

**Pass Criteria:**
- Swipe gesture recognized
- Immediate dismissal
- No lag or delay

---

### Test 10: Multiple Toasts Queue and Display Sequentially

**Objective:** Verify queue handles multiple toasts properly

**Setup:**
- Simulator A: User A in conversation with Bob
- Have 3 different users ready to send messages

**Steps:**
1. Simulator A: Stay in Bob's conversation
2. Rapidly send 3 messages from different users:
   - Charlie: "Message 1"
   - Dave: "Message 2"
   - Eve: "Message 3"
3. Watch toasts appear

**Expected Results:**
- ✅ First toast appears immediately
- ✅ Displays for 4 seconds
- ✅ Dismisses, then second toast appears
- ✅ Second displays for 4 seconds
- ✅ Third toast appears last
- ✅ All 3 toasts eventually shown

**Xcode Console:**
```
🔔 Showing toast: Charlie
📬 Toast queued: Dave - Queue size: 1
📬 Toast queued: Eve - Queue size: 2
[4 seconds later]
🔔 Showing toast: Dave
[4 seconds later]
🔔 Showing toast: Eve
```

**Pass Criteria:**
- Sequential display (not overlapping)
- Each gets full 4 seconds
- Correct order (FIFO)
- No toasts lost

---

## UI/UX Tests (5 tests)

### Test 11: Animation Smoothness

**Objective:** Verify slide animation is smooth and polished

**Visual Criteria:**
- ✅ Slide down from top is smooth (no jank)
- ✅ Spring animation feels natural
- ✅ Slide up on dismiss is smooth
- ✅ 60fps throughout animation
- ✅ No flickering or glitches

**Test:**
1. Trigger toast multiple times
2. Watch animation carefully
3. Try on different simulators (SE, Pro, Pro Max)

**Expected:**
- Spring animation with slight bounce
- Total animation time ~400ms
- Feels iOS-native

**Pass Criteria:**
- Animation smooth on all devices
- No performance issues
- Feels polished

---

### Test 12: Profile Picture Display

**Objective:** Verify profile picture or initials fallback

**Test Cases:**

**Case A: User with profile picture**
- Toast shows AsyncImage
- Profile picture loads and displays
- Circular crop

**Case B: User without profile picture**
- Toast shows initials (first letter of name)
- Blue circle background
- White text
- Size: 44x44pt

**Setup:**
- Create user with photoURL
- Create user without photoURL
- Trigger toasts from both

**Expected Results:**
- ✅ AsyncImage for users with photos
- ✅ Initials fallback for users without
- ✅ Both look good and professional

**Pass Criteria:**
- Images load correctly
- Fallback works reliably
- Consistent sizing

---

### Test 13: Text Readability

**Objective:** Verify all text is readable and well-styled

**Visual Inspection:**
- ✅ Sender name is bold and prominent
- ✅ Message preview is secondary color
- ✅ Text doesn't overflow container
- ✅ Readable in light mode
- ✅ Readable in dark mode

**Test:**
1. Trigger toast in light mode
2. Switch to dark mode
3. Trigger toast again
4. Compare readability

**Expected:**
- Sender name: 15pt, semibold, primary color
- Message preview: 14pt, regular, secondary color
- Line limits respected
- Good contrast in both modes

**Pass Criteria:**
- Text easily readable
- Good hierarchy (name > message)
- Works in both color schemes

---

### Test 14: Safe Area Respect

**Objective:** Verify toast doesn't overlap status bar or notch

**Test on:**
- iPhone SE (no notch)
- iPhone 15 Pro (notch)
- iPhone 15 Pro Max (Dynamic Island)

**Visual Check:**
- ✅ Toast below status bar
- ✅ Toast below notch/Dynamic Island
- ✅ 8pt padding from top safe area
- ✅ No content obscured

**Expected:**
- Toast positioned in safe area
- Respects device-specific layouts
- Readable on all devices

**Pass Criteria:**
- Works on all iPhone models
- No overlap with system UI
- Consistent padding

---

### Test 15: Blur Effect Quality

**Objective:** Verify blur background looks professional

**Visual Criteria:**
- ✅ Frosted glass effect
- ✅ Content behind slightly visible
- ✅ Good contrast with text
- ✅ Shadow adds depth
- ✅ Looks iOS-native

**Test:**
1. Trigger toast over different backgrounds:
   - Chat messages (text)
   - Images in conversation
   - Empty screen
2. Verify blur works well in all cases

**Expected:**
- .ultraThinMaterial blur
- Subtle shadow (10pt radius, black 10% opacity)
- Professional appearance

**Pass Criteria:**
- Blur effect visible
- Text remains readable
- Looks polished

---

## Edge Cases (4 tests)

### Test 16: Very Long Sender Name

**Objective:** Verify UI handles long names gracefully

**Setup:**
```swift
let longName = "Christopher Alexander Montgomery"
```

**Steps:**
1. Send message from user with very long name
2. Observe toast

**Expected Results:**
- ✅ Name truncates with ellipsis if needed
- ✅ Doesn't overflow container
- ✅ Message preview still visible
- ✅ No layout breaking

**Pass Criteria:**
- Long names handled gracefully
- Layout remains intact
- Both name and message visible

---

### Test 17: Empty or Very Short Message

**Objective:** Verify UI handles edge case messages

**Test Cases:**

**Case A: Empty message**
- messageText = ""
- Expected: Shows "New message"

**Case B: Single character**
- messageText = "👍"
- Expected: Shows "👍"

**Case C: Only spaces**
- messageText = "   "
- Expected: Shows trimmed or "New message"

**Pass Criteria:**
- No crashes
- Reasonable fallback displayed
- UI looks okay

---

### Test 18: Navigate Away While Toast Showing

**Objective:** Verify toast handles navigation gracefully

**Steps:**
1. Toast appears (from Charlie)
2. While toast is visible, manually navigate to different conversation (not tap toast)
3. Observe toast behavior

**Expected Results:**
- ✅ Toast remains visible (doesn't interfere)
- ✅ Toast auto-dismisses after remaining time
- ✅ OR: Toast dismisses when leaving chat list
- ✅ No crash or visual glitch

**Pass Criteria:**
- Graceful handling
- No UI conflicts
- No crashes

---

### Test 19: Rapid Messages (Stress Test)

**Objective:** Verify system handles message burst

**Setup:**
- Have 10 different users ready (or same user in 10 conversations)

**Steps:**
1. User A in conversation with User B
2. Send 10 messages as rapidly as possible from different users
3. Observe queue behavior

**Expected Results:**
- ✅ First 5 messages queued
- ✅ 6th+ messages dropped (queue max = 5)
- ✅ All 5 queued toasts eventually display
- ✅ No crashes or performance issues
- ✅ UI remains responsive

**Xcode Console:**
```
📬 Toast queued - Queue size: 1
📬 Toast queued - Queue size: 2
📬 Toast queued - Queue size: 3
📬 Toast queued - Queue size: 4
📬 Toast queued - Queue size: 5
⚠️ Queue full, dropping oldest
```

**Pass Criteria:**
- Queue limit enforced
- No crashes
- Performance acceptable
- Oldest dropped if overflow

---

## Success Criteria Summary

**Feature is complete when ALL of these pass:**

### Functional Requirements ✅
- [x] Toast appears for messages in different conversations
- [x] NO toast for messages in active conversation
- [x] Toast auto-dismisses after 4 seconds
- [x] Tap toast navigates to conversation
- [x] Swipe up dismisses toast early
- [x] Multiple toasts queue sequentially
- [x] Profile picture displays (or initials fallback)
- [x] Message text truncates at 50 characters
- [x] Image messages show "📷 Image"

### Performance Targets ✅
- [x] Toast appears <500ms after message
- [x] Animation smooth (~400ms)
- [x] Auto-dismiss timing accurate (4.0s ±0.2s)
- [x] Navigation response <100ms
- [x] Queue processing <100ms

### Quality Gates ✅
- [x] Animation smooth and polished
- [x] Text readable in light and dark mode
- [x] Blur effect looks professional
- [x] Safe area respected on all devices
- [x] No crashes in any scenario
- [x] Queue handles 10+ messages gracefully

---

## Test Execution Checklist

### Before Testing
- [ ] Implementation complete (all 6 phases)
- [ ] App builds successfully (0 errors)
- [ ] 2 test users created in Firebase
- [ ] Test conversations created
- [ ] Xcode console visible for logs

### During Testing
- [ ] Execute Unit Tests #1-4 (10 minutes)
- [ ] Execute Integration Tests #5-10 (15 minutes)
- [ ] Execute UI/UX Tests #11-15 (10 minutes)
- [ ] Execute Edge Case Tests #16-19 (5 minutes)

**Total Testing Time:** ~40 minutes

### After Testing
- [ ] All 19 tests passed
- [ ] No critical bugs found
- [ ] Performance acceptable
- [ ] Ready to ship!

---

## Quick Test Script

**Fast validation (10 minutes):**

1. **Smoke Test** (2 min)
   - Trigger one toast
   - Verify it appears and dismisses

2. **Tap Test** (1 min)
   - Trigger toast, tap it
   - Verify navigation

3. **Active Conversation Test** (1 min)
   - Be in conversation
   - Send message in that conversation
   - Verify NO toast

4. **Queue Test** (3 min)
   - Send 3 messages rapidly
   - Verify sequential display

5. **Visual Test** (3 min)
   - Check animation smoothness
   - Check text readability
   - Check blur effect

**If all 5 pass:** ✅ Core functionality working!

---

## Troubleshooting Failed Tests

### If Test 5 Fails (Toast doesn't appear)

**Check:**
1. ToastNotificationManager integrated in messAIApp?
2. ChatListViewModel triggering showToast()?
3. Active conversation ID being set?
4. Console logs showing?

**Debug:**
```swift
// Add to ChatListViewModel where message received
print("🐛 New message: \(message.id)")
print("🐛 Active conv: \(ToastNotificationManager.shared.activeConversationId ?? "none")")
print("🐛 Should show: \(ToastNotificationManager.shared.shouldShowToast(conversationId: message.conversationId))")
```

---

### If Test 8 Fails (Tap doesn't navigate)

**Check:**
1. NotificationCenter observer in ChatListView?
2. handleToastTap() posting notification?
3. Conversation exists in conversations array?

**Debug:**
```swift
// In ToastNotificationManager.handleToastTap()
print("👆 Posting notification for: \(conversationId)")

// In ChatListView.onReceive()
print("📱 Received notification: \(conversationId)")
print("📱 Found conversation: \(conversation != nil)")
```

---

## Test Report Template

```markdown
# PR#22.1 In-App Toasts - Test Report

**Date:** [Date]
**Tester:** [Name]
**Duration:** [Time]
**Environment:** iOS Simulator 16.0+

## Summary
- Tests Executed: X/19
- Tests Passed: X/19
- Tests Failed: X/19
- Critical Issues: X
- Pass Rate: XX%

## Unit Tests (4 tests)
- [x] Test #1: Text truncation - PASS
- [x] Test #2: Image messages - PASS
- [x] Test #3: shouldShowToast - PASS
- [x] Test #4: Queue management - PASS

## Integration Tests (6 tests)
- [x] Test #5: Toast appears - PASS
- [x] Test #6: No toast for active - PASS
- [x] Test #7: Auto-dismiss timing - PASS
- [x] Test #8: Tap navigation - PASS
- [x] Test #9: Swipe dismiss - PASS
- [x] Test #10: Queue sequential - PASS

## UI/UX Tests (5 tests)
- [x] Test #11: Animation smooth - PASS
- [x] Test #12: Profile pictures - PASS
- [x] Test #13: Text readable - PASS
- [x] Test #14: Safe area - PASS
- [x] Test #15: Blur effect - PASS

## Edge Cases (4 tests)
- [x] Test #16: Long names - PASS
- [x] Test #17: Edge messages - PASS
- [x] Test #18: Navigate away - PASS
- [x] Test #19: Rapid messages - PASS

## Issues Found
None / [List issues]

## Recommendation
✅ READY TO SHIP / ⚠️ NEEDS FIXES
```

---

**Status:** ✅ TESTING GUIDE COMPLETE  
**Total Test Scenarios:** 19  
**Estimated Test Time:** 40 minutes  
**Coverage:** Unit, Integration, UI/UX, Edge Cases

---

*"Test it like a user would break it."*

