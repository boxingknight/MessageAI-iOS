# PR#17.1: In-App Toast Notifications - Implementation Checklist

**Use this as your daily todo list.** Check off items as you complete them.

**Estimated Total Time:** 2-3 hours  
**Complexity:** MEDIUM (SwiftUI animations, queue management)

---

## Pre-Implementation Setup (5 minutes)

- [ ] Read main planning document (`PR17.1_IN_APP_NOTIFICATIONS.md`) (~30 min)
- [ ] Review Quick Start guide (`PR17.1_README.md`) (~5 min)
- [ ] Prerequisites verified:
  - [ ] PR #10 (Real-Time Messaging) complete ✅
  - [ ] PR #9 (Chat View) complete ✅
  - [ ] PR #7 (Chat List) complete ✅
  - [ ] Xcode 15+ installed
  - [ ] iOS 16+ simulator ready
- [ ] Git branch created (if not already):
  ```bash
  git checkout -b feature/pr17.1-in-app-notifications
  # OR continue on feature/pr17-push-notifications branch
  ```

**Checkpoint:** Ready to start! ✓

---

## Phase 1: Data Model & Service (1 hour)

### 1.1: Create ToastMessage Model (15 minutes)

#### Create New File
- [ ] In Xcode: File → New → File... → Swift File
- [ ] Name: `ToastMessage.swift`
- [ ] Target: `messAI`
- [ ] Group: `Models/`

#### Implement ToastMessage Struct
- [ ] Add imports:
  ```swift
  import Foundation
  ```

- [ ] Create struct with Identifiable and Equatable:
  ```swift
  struct ToastMessage: Identifiable, Equatable {
      let id: String // messageId
      let conversationId: String
      let senderId: String
      let senderName: String
      let senderPhotoURL: String?
      let messageText: String?
      let isImageMessage: Bool
      let timestamp: Date
  }
  ```

- [ ] Add displayText computed property:
  ```swift
  var displayText: String {
      if let text = messageText {
          // Truncate to 50 characters
          if text.count > 50 {
              return String(text.prefix(50)) + "..."
          }
          return text
      } else if isImageMessage {
          return "📷 Image"
      } else {
          return "New message"
      }
  }
  ```

- [ ] Add convenience initializer:
  ```swift
  init(message: Message, sender: User) {
      self.id = message.id
      self.conversationId = message.conversationId
      self.senderId = message.senderId
      self.senderName = sender.displayName
      self.senderPhotoURL = sender.photoURL
      self.messageText = message.text
      self.isImageMessage = message.imageURL != nil
      self.timestamp = message.createdAt
  }
  ```

#### Test Build
- [ ] Press Cmd+B (build)
- [ ] Verify no errors in ToastMessage.swift

**Checkpoint:** ToastMessage model complete! ✓

---

### 1.2: Create ToastNotificationManager (45 minutes)

#### Create New File
- [ ] File → New → File... → Swift File
- [ ] Name: `ToastNotificationManager.swift`
- [ ] Target: `messAI`
- [ ] Group: `Services/`

#### Add Imports and Class Declaration
- [ ] Add imports:
  ```swift
  import Foundation
  import SwiftUI
  import Combine
  ```

- [ ] Create class:
  ```swift
  @MainActor
  class ToastNotificationManager: ObservableObject {
      // Singleton pattern
      static let shared = ToastNotificationManager()
      
      // Published state
      @Published var currentToast: ToastMessage?
      @Published var isShowingToast: Bool = false
      
      // Configuration
      let toastDuration: TimeInterval = 4.0
      
      // Active conversation tracking
      var activeConversationId: String?
      
      // Queue for multiple toasts
      private var toastQueue: [ToastMessage] = []
      private let maxQueueSize = 5
      
      // Timer for auto-dismiss
      private var dismissTask: Task<Void, Never>?
      
      private init() {}
  }
  ```

#### Implement Core Methods
- [ ] Add showToast method:
  ```swift
  // MARK: - Public Methods
  
  /// Show a toast notification
  func showToast(_ toast: ToastMessage) {
      // If already showing toast, queue it
      if isShowingToast {
          queueToast(toast)
          return
      }
      
      // Show toast immediately
      displayToast(toast)
  }
  ```

- [ ] Add displayToast (private helper):
  ```swift
  // MARK: - Private Methods
  
  private func displayToast(_ toast: ToastMessage) {
      currentToast = toast
      
      withAnimation(.spring(response: 0.4, dampingFraction: 0.7)) {
          isShowingToast = true
      }
      
      // Auto-dismiss after duration
      dismissTask?.cancel() // Cancel previous timer
      dismissTask = Task {
          try? await Task.sleep(nanoseconds: UInt64(toastDuration * 1_000_000_000))
          
          // Check if task was cancelled
          if !Task.isCancelled {
              await dismissToast()
          }
      }
  }
  ```

- [ ] Add dismissToast method:
  ```swift
  /// Dismiss current toast
  func dismissToast() {
      dismissTask?.cancel()
      
      withAnimation(.spring(response: 0.3, dampingFraction: 0.8)) {
          isShowingToast = false
      }
      
      // Clear toast after animation completes
      Task {
          try? await Task.sleep(nanoseconds: 300_000_000) // 0.3s animation
          currentToast = nil
          
          // Process next toast in queue
          processNextToast()
      }
  }
  ```

- [ ] Add queue management:
  ```swift
  private func queueToast(_ toast: ToastMessage) {
      // Prevent queue overflow
      if toastQueue.count >= maxQueueSize {
          toastQueue.removeFirst() // Remove oldest
      }
      toastQueue.append(toast)
      
      print("📬 Toast queued: \(toast.senderName) - Queue size: \(toastQueue.count)")
  }
  
  private func processNextToast() {
      guard !toastQueue.isEmpty else { return }
      
      let nextToast = toastQueue.removeFirst()
      displayToast(nextToast)
  }
  ```

- [ ] Add shouldShowToast helper:
  ```swift
  /// Check if should show toast for this conversation
  func shouldShowToast(conversationId: String) -> Bool {
      // Don't show if user is in that conversation
      guard let activeId = activeConversationId else {
          // User is on chat list, don't show toasts there
          return false
      }
      
      return conversationId != activeId
  }
  ```

- [ ] Add navigation handler:
  ```swift
  /// Handle toast tap (navigate to conversation)
  func handleToastTap(conversationId: String) {
      print("👆 Toast tapped: Navigate to \(conversationId)")
      
      // Dismiss toast first
      dismissToast()
      
      // Post notification for navigation
      NotificationCenter.default.post(
          name: NSNotification.Name("OpenConversationFromToast"),
          object: nil,
          userInfo: ["conversationId": conversationId]
      )
  }
  ```

#### Test Build
- [ ] Press Cmd+B
- [ ] Verify no errors in ToastNotificationManager.swift

**Checkpoint:** ToastNotificationManager complete! ✓

**Commit:**
```bash
git add Models/ToastMessage.swift
git add Services/ToastNotificationManager.swift
git commit -m "[PR #17.1] Phase 1: ToastMessage model and ToastNotificationManager service"
```

---

## Phase 2: Toast UI Component (1 hour)

### 2.1: Create ToastNotificationView (1 hour)

#### Create New File
- [ ] File → New → File... → Swift File
- [ ] Name: `ToastNotificationView.swift`
- [ ] Target: `messAI`
- [ ] Group: `Views/Components/` (create Components folder if needed)

#### Add Imports
- [ ] Add:
  ```swift
  import SwiftUI
  ```

#### Create View Structure
- [ ] Add view struct:
  ```swift
  struct ToastNotificationView: View {
      @ObservedObject var manager: ToastNotificationManager
      
      var body: some View {
          ZStack(alignment: .top) {
              if manager.isShowingToast, let toast = manager.currentToast {
                  toastContent(toast)
                      .transition(.move(edge: .top).combined(with: .opacity))
              }
          }
          .animation(.spring(response: 0.4, dampingFraction: 0.7), value: manager.isShowingToast)
      }
  }
  ```

#### Implement Toast Content
- [ ] Add toastContent view builder:
  ```swift
  @ViewBuilder
  private func toastContent(_ toast: ToastMessage) -> some View {
      HStack(spacing: 12) {
          // Profile picture
          profilePicture(for: toast)
          
          // Content
          VStack(alignment: .leading, spacing: 4) {
              // Sender name
              Text(toast.senderName)
                  .font(.system(size: 15, weight: .semibold))
                  .foregroundColor(.primary)
                  .lineLimit(1)
              
              // Message preview
              Text(toast.displayText)
                  .font(.system(size: 14))
                  .foregroundColor(.secondary)
                  .lineLimit(2)
          }
          
          Spacer()
      }
      .padding(.horizontal, 16)
      .padding(.vertical, 12)
      .frame(height: 70)
      .background(
          RoundedRectangle(cornerRadius: 16)
              .fill(.ultraThinMaterial)
              .shadow(color: .black.opacity(0.1), radius: 10, x: 0, y: 5)
      )
      .padding(.horizontal, 16)
      .padding(.top, 8)
      .onTapGesture {
          manager.handleToastTap(conversationId: toast.conversationId)
      }
      .gesture(
          DragGesture(minimumDistance: 20)
              .onEnded { value in
                  // Swipe up to dismiss
                  if value.translation.height < -50 {
                      manager.dismissToast()
                  }
              }
      )
  }
  ```

#### Add Profile Picture View
- [ ] Add profilePicture helper:
  ```swift
  @ViewBuilder
  private func profilePicture(for toast: ToastMessage) -> some View {
      if let photoURL = toast.senderPhotoURL,
         let url = URL(string: photoURL) {
          AsyncImage(url: url) { image in
              image
                  .resizable()
                  .scaledToFill()
                  .frame(width: 44, height: 44)
                  .clipShape(Circle())
          } placeholder: {
              initialsPlaceholder(for: toast)
          }
      } else {
          initialsPlaceholder(for: toast)
      }
  }
  
  @ViewBuilder
  private func initialsPlaceholder(for toast: ToastMessage) -> some View {
      ZStack {
          Circle()
              .fill(Color.blue.opacity(0.2))
              .frame(width: 44, height: 44)
          
          Text(toast.senderName.prefix(1).uppercased())
              .font(.system(size: 18, weight: .semibold))
              .foregroundColor(.blue)
      }
  }
  ```

#### Add Preview
- [ ] Add SwiftUI preview:
  ```swift
  #Preview {
      let manager = ToastNotificationManager.shared
      
      // Create sample toast
      let sampleUser = User(
          id: "user1",
          displayName: "Alice Test",
          email: "alice@test.com",
          photoURL: nil,
          isOnline: true,
          lastSeen: Date(),
          createdAt: Date()
      )
      
      let sampleMessage = Message(
          id: "msg1",
          conversationId: "conv1",
          senderId: "user1",
          text: "Hey! Are you there? I wanted to ask you something.",
          createdAt: Date()
      )
      
      let toast = ToastMessage(message: sampleMessage, sender: sampleUser)
      
      // Show toast
      manager.currentToast = toast
      manager.isShowingToast = true
      
      return VStack {
          Spacer()
      }
      .overlay(alignment: .top) {
          ToastNotificationView(manager: manager)
      }
  }
  ```

#### Test in Preview
- [ ] Open preview in Xcode (Cmd+Option+Enter)
- [ ] Verify toast appears at top
- [ ] Check layout looks good
- [ ] Verify blur background effect

**Checkpoint:** Toast UI component complete! ✓

**Commit:**
```bash
git add Views/Components/ToastNotificationView.swift
git commit -m "[PR #17.1] Phase 2: ToastNotificationView with animations and gestures"
```

---

## Phase 3: App Integration (30 minutes)

### 3.1: Add Toast Overlay to App (10 minutes)

#### Open messAIApp.swift
- [ ] Navigate to `messAI/messAIApp.swift`

#### Add Toast Overlay
- [ ] Update body to include toast overlay:
  ```swift
  var body: some Scene {
      WindowGroup {
          ContentView()
              .environmentObject(authViewModel)
              .overlay(alignment: .top) {
                  // Toast Notification Overlay (PR #17.1)
                  ToastNotificationView(manager: .shared)
                      .zIndex(999) // Ensure it's on top
              }
              .onOpenURL { url in
                  // Existing deep link handling...
                  NotificationService.shared.handleDeepLink(url)
              }
      }
  }
  ```

#### Test Build
- [ ] Press Cmd+B
- [ ] Verify no errors

---

### 3.2: Update ChatListViewModel to Trigger Toasts (15 minutes)

#### Open ChatListViewModel.swift
- [ ] Navigate to `ViewModels/ChatListViewModel.swift`

#### Add Toast Trigger Logic
- [ ] Find the real-time listener where new messages are received
- [ ] Add toast trigger after message is added to local array:
  ```swift
  // In your real-time listener (listenToConversations or similar)
  // After receiving new message and updating local state
  
  // Trigger toast notification (PR #17.1)
  Task { @MainActor in
      // Check if should show toast
      if ToastNotificationManager.shared.shouldShowToast(conversationId: message.conversationId) {
          // Fetch sender info
          if let sender = await fetchUser(userId: message.senderId) {
              let toast = ToastMessage(message: message, sender: sender)
              ToastNotificationManager.shared.showToast(toast)
          }
      }
  }
  ```

#### Add Helper Method (if needed)
- [ ] Add fetchUser helper if it doesn't exist:
  ```swift
  // MARK: - Helper Methods
  
  private func fetchUser(userId: String) async -> User? {
      do {
          let db = Firestore.firestore()
          let document = try await db.collection("users").document(userId).getDocument()
          
          guard let data = document.data() else { return nil }
          return User(from: data)
      } catch {
          print("❌ Error fetching user: \(error)")
          return nil
      }
  }
  ```

**Note:** You may already have a method to get User from conversation participants. Use that if available!

#### Test Build
- [ ] Press Cmd+B
- [ ] Verify no errors

---

### 3.3: Update ChatView to Track Active Conversation (5 minutes)

#### Open ChatView.swift
- [ ] Navigate to `Views/Chat/ChatView.swift`

#### Add Active Conversation Tracking
- [ ] Add to body modifiers:
  ```swift
  .onAppear {
      // Existing onAppear code...
      
      // Track active conversation (PR #17.1)
      ToastNotificationManager.shared.activeConversationId = conversation.id
  }
  .onDisappear {
      // Clear active conversation (PR #17.1)
      ToastNotificationManager.shared.activeConversationId = nil
  }
  ```

#### Test Build
- [ ] Press Cmd+B
- [ ] Verify no errors

**Checkpoint:** Integration complete! ✓

**Commit:**
```bash
git add messAI/messAIApp.swift
git add ViewModels/ChatListViewModel.swift
git add Views/Chat/ChatView.swift
git commit -m "[PR #17.1] Phase 3: Integrated toast notifications into app lifecycle"
```

---

## Phase 4: Navigation Handling (30 minutes)

### 4.1: Add Navigation from Toast Tap (20 minutes)

#### Open ChatListView.swift
- [ ] Navigate to `Views/Chat/ChatListView.swift`

#### Add NotificationCenter Observer
- [ ] Add to body modifiers:
  ```swift
  .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("OpenConversationFromToast"))) { notification in
      guard let userInfo = notification.userInfo,
            let conversationId = userInfo["conversationId"] as? String else {
          return
      }
      
      print("📱 Opening conversation from toast: \(conversationId)")
      
      // Find conversation in list
      if let conversation = viewModel.conversations.first(where: { $0.id == conversationId }) {
          // Navigate to conversation
          // Adjust based on your navigation pattern:
          
          // Option A: If using NavigationLink with selection
          self.selectedConversation = conversation
          
          // Option B: If using programmatic navigation
          self.navigationPath.append(conversation)
          
          // Option C: If using different pattern, adjust accordingly
      }
  }
  ```

**Note:** Adjust the navigation code to match your existing navigation pattern in ChatListView!

#### Test Build
- [ ] Press Cmd+B
- [ ] Verify no errors

---

### 4.2: Add Auto-Dismiss on Navigation (10 minutes)

#### Update Toast Dismiss Logic
- [ ] In ToastNotificationManager, the dismiss already happens in `handleToastTap()`
- [ ] Verify the flow:
  1. User taps toast
  2. `handleToastTap()` called
  3. Toast dismissed first
  4. Then NavigationCenter notification posted
  5. ChatListView receives and navigates

#### Test Logic
- [ ] Review ToastNotificationManager.handleToastTap()
- [ ] Confirm dismissToast() is called before posting notification
- [ ] This ensures toast disappears before navigation

**Checkpoint:** Navigation handling complete! ✓

**Commit:**
```bash
git add Views/Chat/ChatListView.swift
git commit -m "[PR #17.1] Phase 4: Navigation from toast tap with NotificationCenter"
```

---

## Phase 5: Testing & Polish (30 minutes)

### 5.1: Manual Testing (20 minutes)

#### Setup Test Environment
- [ ] Run app in Simulator A (User A)
- [ ] Run app in Simulator B (User B) - OR use different device
- [ ] Sign in as different users

#### Test Scenario 1: Basic Toast Display
- [ ] Simulator A: Open conversation with User B
- [ ] Simulator B: Have User C send message to User A
- [ ] **Expected:** Toast appears on Simulator A showing User C's message
- [ ] **Verify:** Toast shows profile picture, name, message preview
- [ ] **Verify:** Toast auto-dismisses after 4 seconds

#### Test Scenario 2: No Self-Notification
- [ ] Simulator A: Open conversation with User B
- [ ] Simulator B: Send message to User A (active conversation)
- [ ] **Expected:** NO toast appears (already in that conversation)
- [ ] **Verify:** Message appears via real-time listener, but no toast

#### Test Scenario 3: Toast Navigation
- [ ] Simulator A: Open conversation with User B
- [ ] Simulator B: Have User C send message to User A
- [ ] **Action:** Tap the toast immediately
- [ ] **Expected:** Toast dismisses, navigates to User C conversation
- [ ] **Verify:** ChatView opens with User C, messages visible

#### Test Scenario 4: Swipe to Dismiss
- [ ] Trigger toast appearance
- [ ] **Action:** Swipe up on the toast
- [ ] **Expected:** Toast dismisses immediately (before 4 seconds)

#### Test Scenario 5: Multiple Toasts (Queue)
- [ ] Simulator A: Open conversation with User B
- [ ] Simulator B: Have 3 different users send messages rapidly
- [ ] **Expected:** Toasts appear one at a time (queued)
- [ ] **Verify:** Each toast displays for 4 seconds before next
- [ ] **Verify:** All 3 messages eventually show toasts

#### Test Scenario 6: Long Message Truncation
- [ ] Have someone send a very long message (100+ characters)
- [ ] **Expected:** Message preview truncates at 50 chars with "..."
- [ ] **Verify:** Toast remains readable and doesn't overflow

#### Test Scenario 7: Group Messages
- [ ] Be in group chat, have someone send message
- [ ] **Expected:** Toast shows with sender name
- [ ] **Verify:** Format: "GroupName - Sender: Message"

#### Test Scenario 8: Image Messages
- [ ] Have someone send image message
- [ ] **Expected:** Toast shows "📷 Image"
- [ ] **Verify:** No crash, icon visible

**Testing Notes:**
- [ ] Record any bugs found
- [ ] Note any UI issues
- [ ] Check animation smoothness

---

### 5.2: Polish & Bug Fixes (10 minutes)

#### Fix Any Issues Found
- [ ] Address bugs from testing
- [ ] Adjust animation timing if needed
- [ ] Fix any layout issues on different screen sizes

#### Verify Safe Area
- [ ] Check toast doesn't overlap status bar
- [ ] Test on different iPhone sizes (SE, Pro Max, etc.)
- [ ] Adjust padding if needed

#### Performance Check
- [ ] Send 10 messages rapidly, verify no lag
- [ ] Check memory usage (should be minimal)
- [ ] Verify no memory leaks (toasts properly dismissed)

**Checkpoint:** Testing and polish complete! ✓

**Commit:**
```bash
git add .
git commit -m "[PR #17.1] Phase 5: Testing complete, bug fixes and polish applied"
```

---

## Phase 6: Final Build & Documentation (10 minutes)

### 6.1: Clean Build (5 minutes)

#### Clean and Rebuild
- [ ] Xcode: Product → Clean Build Folder (Cmd+Shift+K)
- [ ] Xcode: Product → Build (Cmd+B)
- [ ] Verify: 0 errors, 0 warnings

#### Test Final Build
- [ ] Run app (Cmd+R)
- [ ] Quick smoke test (trigger one toast, tap it, verify navigation)
- [ ] Confirm everything works

---

### 6.2: Update Documentation (5 minutes)

#### Update Memory Bank
- [ ] Update `memory-bank/activeContext.md`:
  ```markdown
  ### ✅ Just Completed: PR #17.1 - In-App Toast Notifications 🎉
  
  **Completion Date**: [Date]
  **Time Taken**: X hours actual (2-3 hours estimated)
  **Status**: COMPLETE - Toast notifications working!
  
  **What Was Built**:
  - ToastMessage model with truncation and image handling
  - ToastNotificationManager with queue and auto-dismiss
  - ToastNotificationView with slide animations and blur effect
  - Integration into app lifecycle (ChatListViewModel, ChatView)
  - Navigation from toast tap
  
  **Key Achievement**: MVP-quality notifications without Apple Developer account!
  ```

#### Update Progress
- [ ] Update `memory-bank/progress.md`:
  ```markdown
  - ✅ PR #17.1: In-App Toast Notifications (X hours) ✅ COMPLETE! 🎉
  ```

---

## Completion Checklist

### ✅ All Features Implemented
- [x] ToastMessage model created
- [x] ToastNotificationManager implemented
- [x] ToastNotificationView with animations
- [x] Integration into app lifecycle
- [x] Active conversation tracking
- [x] Navigation from toast tap
- [x] Queue management for multiple toasts
- [x] Auto-dismiss after 4 seconds
- [x] Swipe to dismiss gesture

### ✅ All Tests Passed
- [x] Toast appears for messages in other conversations
- [x] No toast for messages in active conversation
- [x] Toast auto-dismisses after 4 seconds
- [x] Tap toast navigates to conversation
- [x] Swipe up dismisses toast
- [x] Multiple toasts queue properly
- [x] Long messages truncate correctly
- [x] Image messages show "📷 Image"

### ✅ Quality Standards Met
- [x] No compiler errors or warnings
- [x] Animation smooth and polished
- [x] Toast respects safe area
- [x] Navigation works reliably
- [x] No memory leaks
- [x] Queue handles 10+ toasts gracefully
- [x] All files committed to git

### ✅ User Experience Verified
- [x] Toast appears within 1 second of message
- [x] Toast is readable and attractive
- [x] Blur effect looks professional
- [x] Navigation is instant (<100ms)
- [x] No spam or annoyance
- [x] Works on all iPhone screen sizes

---

## Time Tracking

| Phase | Estimated | Actual | Notes |
|-------|-----------|--------|-------|
| Pre-Setup | 5 min | ___ min | Reading docs |
| Phase 1: Model & Manager | 1h | ___ h | ToastMessage, ToastNotificationManager |
| Phase 2: UI Component | 1h | ___ h | ToastNotificationView |
| Phase 3: Integration | 30 min | ___ min | App lifecycle integration |
| Phase 4: Navigation | 30 min | ___ min | Toast tap handling |
| Phase 5: Testing | 30 min | ___ min | Manual testing |
| Phase 6: Final | 10 min | ___ min | Build & docs |
| **TOTAL** | **2-3h** | **___ h** | |

---

## Celebration! 🎉

**YOU DID IT!** You've implemented in-app toast notifications without needing an Apple Developer account!

**What this means:**
- ✅ Users see notifications for messages in other chats
- ✅ Professional messaging app experience
- ✅ Can test immediately in simulator
- ✅ Foundation ready for PR #17 (push notifications) later

**Next Steps:**
1. Test with real users for feedback
2. Consider adding sound/haptic feedback (optional)
3. When Apple Developer account ready, upgrade to PR #17
4. Continue with other features (Image Sharing, Profile, etc.)

---

**Status:** ✅ READY TO IMPLEMENT  
**Complexity:** MEDIUM  
**Time:** 2-3 hours  
**Impact:** 🎯 MVP-quality notifications without credentials!

---

*"Ship what works today, perfect it tomorrow."*

