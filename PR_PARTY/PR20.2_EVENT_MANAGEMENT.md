# PR#20.2: Event Management - Info Button & Events Sheet

**Status:** ðŸ“‹ **DOCUMENTATION COMPLETE** (Ready for Implementation)  
**Branch**: `feature/pr20.2-event-management` (to be created)  
**Timeline**: 6-8 hours estimated  
**Priority**: ðŸ”µ HIGH - Completes event lifecycle (create â†’ view â†’ manage)  
**Depends on**: PR#20.1 (Proactive Agent) âœ…  
**Created**: October 24, 2025

---

## ðŸ“‹ **Table of Contents**

1. [Overview](#overview)
2. [User Stories](#user-stories)
3. [UI/UX Specification](#uiux-specification)
4. [Technical Architecture](#technical-architecture)
5. [Data Models](#data-models)
6. [Implementation Strategy](#implementation-strategy)
7. [Edge Cases & Error Handling](#edge-cases--error-handling)
8. [Testing Strategy](#testing-strategy)
9. [Success Criteria](#success-criteria)

---

## ðŸŽ¯ **Overview**

### **Problem**
After PR#20.1, users can CREATE events via Ambient Bar, but:
- âŒ Can't view all events in a conversation (past & future)
- âŒ Can't edit event details (creator needs to fix mistakes)
- âŒ Can't cancel events (plans change!)
- âŒ No way to see who RSVP'd without scrolling through Ambient Bars
- âŒ Past events disappear (no history)

### **Solution**
Add an **Info button** (top right of ChatView) that opens a **full-screen Events Sheet** showing:
- All events (upcoming & past)
- Event details (date, time, location, RSVPs)
- Management actions (edit, cancel for creators)
- Quick actions (add to calendar, change RSVP)

### **Design Philosophy**
**Apple Calendar Style:**
- Clean, minimalist design
- List of events (grouped by time)
- Tap event â†’ See full details
- Clear roles (creator vs participant)

### **Scope**
**In Scope:**
- âœ… Info button UI (top right of ChatView)
- âœ… Events List Sheet (full-screen)
- âœ… Event Detail Modal (tap event)
- âœ… View all events (upcoming & past)
- âœ… Edit event (creator only)
- âœ… Cancel event (creator only)
- âœ… Add to calendar (all users)
- âœ… Change RSVP (participants)
- âœ… Real-time updates (Firestore listeners)

**Out of Scope (Future PRs):**
- âŒ Event reminders/notifications
- âŒ Recurring events
- âŒ Event attachments (images, files)
- âŒ External calendar sync (Google Calendar, etc.)
- âŒ Event chat/comments

---

## ðŸ‘¤ **User Stories**

### **Story 1: View All Events**
**As a** parent in a group chat  
**I want to** see all events we've planned (past & future)  
**So that** I can keep track of our schedule and see what's coming up

**Acceptance Criteria:**
- Tap Info button (top right) â†’ Opens Events Sheet
- See list of all events in conversation
- Events grouped by "Upcoming" and "Past"
- Each event shows: title, date, time, RSVP count
- Tap event â†’ Opens Event Detail Modal

---

### **Story 2: Edit Event (Creator)**
**As an** event creator  
**I want to** edit event details after creating it  
**So that** I can fix mistakes or update plans as they change

**Acceptance Criteria:**
- Open Event Detail â†’ See "Edit Event" button (creator only)
- Tap "Edit Event" â†’ Opens Edit Modal
- Can change: title, date, time, location, notes
- Tap "Save" â†’ Event updates for all users
- All Ambient Bars update in real-time
- System message in chat: "User2 updated Party: New time is 8PM"

---

### **Story 3: Cancel Event (Creator)**
**As an** event creator  
**I want to** cancel an event  
**So that** other parents know the event is no longer happening

**Acceptance Criteria:**
- Open Event Detail â†’ See "Cancel Event" button (creator only)
- Tap "Cancel Event" â†’ Shows confirmation dialog
- Tap "Confirm" â†’ Event status â†’ "cancelled"
- All Ambient Bars dismiss (all users)
- System message in chat: "User2 cancelled Party on Oct 31"
- Event still visible in Events Sheet (with "Cancelled" badge)

---

### **Story 4: Quick Access to Calendar**
**As a** participant  
**I want to** quickly add an event to my iOS Calendar  
**So that** I don't forget about it

**Acceptance Criteria:**
- Open Event Detail â†’ See "Add to Calendar" button
- Tap "Add to Calendar" â†’ Opens iOS Calendar with event pre-filled
- User can confirm/edit before saving
- Button shows "Added âœ“" after adding (local state, not synced)

---

### **Story 5: Change RSVP**
**As a** participant  
**I want to** change my RSVP after initially responding  
**So that** I can update my availability if plans change

**Acceptance Criteria:**
- Open Event Detail â†’ See current RSVP status
- Tap "Change Response" â†’ Shows options (Yes/No/Maybe)
- Tap option â†’ RSVP updates in Firestore
- Event Detail refreshes with new RSVP list
- Ambient Bar updates (if still active)

---

## ðŸŽ¨ **UI/UX Specification**

### **1. Info Button (ChatView Header)**

**Location:** Top right of ChatView (next to AAA button)

**Visual:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Chat Name          â“˜ AAA     â”‚ â† Info button (circle with 'i')
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  [Chat messages...]             â”‚
â”‚                                 â”‚
```

**Behavior:**
- Tap â†’ Opens Events Sheet (full-screen)
- Badge: Show count if there are active events (e.g., "â“˜ 3")
- Animation: Fade in/out

**Implementation:**
```swift
Button(action: {
    showEventsSheet = true
}) {
    ZStack {
        Image(systemName: "info.circle")
            .font(.title2)
        
        // Badge for event count
        if eventCount > 0 {
            Text("\(eventCount)")
                .font(.caption2)
                .foregroundColor(.white)
                .padding(4)
                .background(Color.red)
                .clipShape(Circle())
                .offset(x: 10, y: -10)
        }
    }
}
.sheet(isPresented: $showEventsSheet) {
    EventsListView(conversationId: conversationId)
}
```

---

### **2. Events List Sheet (Full-Screen)**

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Events                   [Done]â”‚ â† Navigation bar
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  Upcoming (3)                   â”‚ â† Section header
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸ“… Party                   â”‚ â”‚
â”‚  â”‚ Oct 31 at 7PM              â”‚ â”‚
â”‚  â”‚ âœ… 3 going  âŒ 1 no        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸŠ Swimming                â”‚ â”‚
â”‚  â”‚ Nov 2 at 1PM               â”‚ â”‚
â”‚  â”‚ â³ 5 pending               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸŽ® Poker Night             â”‚ â”‚
â”‚  â”‚ Nov 5 at 9PM               â”‚ â”‚
â”‚  â”‚ âœ… 2 going  â³ 3 pending   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Past (2)                       â”‚ â† Section header
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âš½ Soccer Practice          â”‚ â”‚
â”‚  â”‚ Oct 20 - Completed         â”‚ â”‚
â”‚  â”‚ âœ… 4 attended              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ðŸŽ¨ Playdate                â”‚ â”‚
â”‚  â”‚ Oct 18 - Completed         â”‚ â”‚
â”‚  â”‚ âœ… 3 attended              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  [Empty space for scrolling]   â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components:**

**Navigation Bar:**
- Title: "Events"
- Right button: "Done" (dismisses sheet)

**Section Headers:**
- "Upcoming (count)" - Events in the future
- "Past (count)" - Events that already happened

**Event Row:**
- Icon: Event type emoji (ðŸŽ‰ ðŸ“… ðŸŠ âš½)
- Title: Event name
- Subtitle: Date & time
- RSVP Summary: Visual indicators (âœ… âŒ â³)
- Tap â†’ Opens Event Detail Modal

**Empty State:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Events                   [Done]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚         ðŸ“…                      â”‚
â”‚                                 â”‚
â”‚    No Events Yet                â”‚
â”‚                                 â”‚
â”‚  Events created in this chat    â”‚
â”‚  will appear here               â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation:**
```swift
struct EventsListView: View {
    let conversationId: String
    @StateObject private var viewModel: EventsListViewModel
    @Environment(\.dismiss) var dismiss
    
    var body: some View {
        NavigationView {
            List {
                if !viewModel.upcomingEvents.isEmpty {
                    Section(header: Text("Upcoming (\(viewModel.upcomingEvents.count))")) {
                        ForEach(viewModel.upcomingEvents) { event in
                            EventRowView(event: event)
                                .onTapGesture {
                                    viewModel.selectedEvent = event
                                }
                        }
                    }
                }
                
                if !viewModel.pastEvents.isEmpty {
                    Section(header: Text("Past (\(viewModel.pastEvents.count))")) {
                        ForEach(viewModel.pastEvents) { event in
                            EventRowView(event: event)
                                .onTapGesture {
                                    viewModel.selectedEvent = event
                                }
                        }
                    }
                }
            }
            .navigationTitle("Events")
            .navigationBarTitleDisplayMode(.large)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("Done") {
                        dismiss()
                    }
                }
            }
            .sheet(item: $viewModel.selectedEvent) { event in
                EventDetailView(event: event)
            }
        }
    }
}
```

---

### **3. Event Detail Modal**

**Layout (Participant View):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Event Details    [Ã—]   â”‚ â† Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  ðŸ“… Party                       â”‚ â† Event icon + title
â”‚  October 31, 2025               â”‚ â† Date (formatted)
â”‚  7:00 PM                        â”‚ â† Time (formatted)
â”‚  ðŸ“ John's house                â”‚ â† Location (if provided)
â”‚  ðŸ‘¤ Created by User2            â”‚ â† Creator
â”‚                                 â”‚
â”‚  RSVP Status (5)                â”‚ â† Section header
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… User1 (Yes)             â”‚ â”‚
â”‚  â”‚ âœ… User2 (Yes)             â”‚ â”‚
â”‚  â”‚ âŒ User3 (No)              â”‚ â”‚
â”‚  â”‚ â³ User4 (Pending)         â”‚ â”‚
â”‚  â”‚ â³ User5 (Pending)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Your Response: Yes âœ…          â”‚ â† Current user's RSVP
â”‚                                 â”‚
â”‚  [ðŸ“… Add to Calendar]          â”‚ â† Primary button
â”‚  [ðŸ”” Change Response]          â”‚ â† Secondary button
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Layout (Creator View):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Event Details    [Ã—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  ðŸ“… Party                       â”‚
â”‚  October 31, 2025               â”‚
â”‚  7:00 PM                        â”‚
â”‚  ðŸ“ John's house                â”‚
â”‚  ðŸ‘¤ You created this event      â”‚ â† Different text for creator
â”‚                                 â”‚
â”‚  RSVP Status (5)                â”‚
â”‚  [Same as participant view]     â”‚
â”‚                                 â”‚
â”‚  [ðŸ“… Add to Calendar]          â”‚
â”‚  [âœï¸ Edit Event]               â”‚ â† Creator action
â”‚  [ðŸ—‘ï¸ Cancel Event]             â”‚ â† Creator action (red)
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components:**

**Header:**
- Title: "Event Details"
- Right button: Close (Ã—)

**Event Info:**
- Icon: Event type emoji (large, 48pt)
- Title: Event name (font: .title2, bold)
- Date: Formatted (e.g., "October 31, 2025")
- Time: Formatted (e.g., "7:00 PM")
- Location: Optional, with pin icon
- Creator: "Created by [name]" or "You created this event"

**RSVP Section:**
- Header: "RSVP Status (count)"
- List of participants with status:
  - âœ… Green checkmark = Yes
  - âŒ Red X = No
  - â³ Yellow clock = Pending/Maybe
- Display names (not user IDs)

**User's Response:**
- "Your Response: [status]" with appropriate emoji
- Highlighted with subtle background color

**Action Buttons:**

**For All Users:**
- "Add to Calendar" (blue, primary button)
  - Icon: ðŸ“…
  - Opens iOS Calendar with event

**For Participants:**
- "Change Response" (purple, secondary button)
  - Icon: ðŸ””
  - Opens action sheet with Yes/No/Maybe options

**For Creator:**
- "Edit Event" (purple, secondary button)
  - Icon: âœï¸
  - Opens edit modal
- "Cancel Event" (red, destructive button)
  - Icon: ðŸ—‘ï¸
  - Shows confirmation alert

**Implementation:**
```swift
struct EventDetailView: View {
    let event: EventDocument
    @StateObject private var viewModel: EventDetailViewModel
    @Environment(\.dismiss) var dismiss
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(alignment: .leading, spacing: 20) {
                    // Event info section
                    eventInfoSection
                    
                    Divider()
                    
                    // RSVP section
                    rsvpSection
                    
                    Divider()
                    
                    // Actions section
                    actionsSection
                }
                .padding()
            }
            .navigationTitle("Event Details")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button(action: { dismiss() }) {
                        Image(systemName: "xmark.circle.fill")
                            .foregroundColor(.gray)
                    }
                }
            }
        }
    }
    
    private var eventInfoSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            // Icon + Title
            HStack {
                Text(event.icon)
                    .font(.system(size: 48))
                
                Text(event.title)
                    .font(.title2)
                    .fontWeight(.bold)
            }
            
            // Date
            Label(event.formattedDate, systemImage: "calendar")
                .font(.body)
            
            // Time
            Label(event.formattedTime, systemImage: "clock")
                .font(.body)
            
            // Location (if available)
            if let location = event.location, !location.isEmpty {
                Label(location, systemImage: "mappin.and.ellipse")
                    .font(.body)
            }
            
            // Creator
            Label(event.creatorText, systemImage: "person.circle")
                .font(.subheadline)
                .foregroundColor(.secondary)
        }
    }
    
    private var rsvpSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("RSVP Status (\(event.rsvps.count))")
                .font(.headline)
            
            ForEach(Array(event.rsvps.keys.sorted()), id: \.self) { userId in
                if let response = event.rsvps[userId] {
                    HStack {
                        Image(systemName: response.icon)
                            .foregroundColor(response.color)
                        
                        Text(viewModel.displayName(for: userId))
                            .font(.body)
                        
                        Spacer()
                        
                        Text(response.capitalized)
                            .font(.caption)
                            .foregroundColor(response.color)
                    }
                }
            }
            
            // Current user's response (highlighted)
            if let userResponse = event.rsvps[viewModel.currentUserId] {
                HStack {
                    Text("Your Response:")
                        .font(.subheadline)
                        .fontWeight(.semibold)
                    
                    Text(userResponse.capitalized)
                        .font(.subheadline)
                        .foregroundColor(userResponse.color)
                    
                    Image(systemName: userResponse.icon)
                        .foregroundColor(userResponse.color)
                }
                .padding(12)
                .background(userResponse.backgroundColor)
                .cornerRadius(8)
            }
        }
    }
    
    private var actionsSection: some View {
        VStack(spacing: 12) {
            // Add to Calendar (all users)
            Button(action: {
                viewModel.addToCalendar()
            }) {
                Label("Add to Calendar", systemImage: "calendar.badge.plus")
                    .frame(maxWidth: .infinity)
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(10)
            }
            
            // Creator actions
            if viewModel.isCreator {
                Button(action: {
                    viewModel.showEditModal = true
                }) {
                    Label("Edit Event", systemImage: "pencil")
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(Color.purple.opacity(0.1))
                        .foregroundColor(.purple)
                        .cornerRadius(10)
                }
                
                Button(action: {
                    viewModel.showCancelConfirmation = true
                }) {
                    Label("Cancel Event", systemImage: "trash")
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(Color.red.opacity(0.1))
                        .foregroundColor(.red)
                        .cornerRadius(10)
                }
            } else {
                // Participant action
                Button(action: {
                    viewModel.showChangeRSVP = true
                }) {
                    Label("Change Response", systemImage: "arrow.clockwise")
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(Color.purple.opacity(0.1))
                        .foregroundColor(.purple)
                        .cornerRadius(10)
                }
            }
        }
        .sheet(isPresented: $viewModel.showEditModal) {
            EventEditView(event: event)
        }
        .confirmationDialog("Cancel Event", isPresented: $viewModel.showCancelConfirmation) {
            Button("Cancel Event", role: .destructive) {
                viewModel.cancelEvent()
            }
            Button("Keep Event", role: .cancel) {}
        } message: {
            Text("This will cancel the event for all participants. This action cannot be undone.")
        }
        .actionSheet(isPresented: $viewModel.showChangeRSVP) {
            ActionSheet(
                title: Text("Change Your Response"),
                buttons: [
                    .default(Text("âœ… Yes, I'll attend")) {
                        viewModel.changeRSVP(to: "yes")
                    },
                    .default(Text("âŒ No, can't make it")) {
                        viewModel.changeRSVP(to: "no")
                    },
                    .default(Text("â³ Maybe")) {
                        viewModel.changeRSVP(to: "maybe")
                    },
                    .cancel()
                ]
            )
        }
    }
}
```

---

### **4. Event Edit Modal (Creator Only)**

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit Event        [Cancel][Save]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  Event Title                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Party                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Date                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ October 31, 2025    [ðŸ“…]  â”‚ â”‚ â† Date picker
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Time                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 7:00 PM             [ðŸ•]  â”‚ â”‚ â† Time picker
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Location (Optional)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ John's house               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Notes (Optional)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Bring snacks and drinks    â”‚ â”‚
â”‚  â”‚                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components:**

**Navigation Bar:**
- Title: "Edit Event"
- Left button: "Cancel" (dismisses without saving)
- Right button: "Save" (saves changes, dismisses)

**Form Fields:**
- Event Title (TextField, required)
- Date (DatePicker, required)
- Time (DatePicker, required)
- Location (TextField, optional)
- Notes (TextEditor, optional, multiline)

**Validation:**
- Title: Cannot be empty
- Date: Must be in the future (or allow past for fixing mistakes?)
- Time: Any time valid
- Save button disabled until all required fields valid

**Behavior:**
- Tap "Cancel" â†’ Shows confirmation if changes made
- Tap "Save" â†’ Updates event in Firestore
- All devices receive update via listener
- System message in chat: "User2 updated Party: New time is 8PM"

**Implementation:**
```swift
struct EventEditView: View {
    @StateObject private var viewModel: EventEditViewModel
    @Environment(\.dismiss) var dismiss
    
    init(event: EventDocument) {
        _viewModel = StateObject(wrappedValue: EventEditViewModel(event: event))
    }
    
    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("Event Details")) {
                    TextField("Event Title", text: $viewModel.title)
                    
                    DatePicker("Date", selection: $viewModel.date, displayedComponents: .date)
                    
                    DatePicker("Time", selection: $viewModel.time, displayedComponents: .hourAndMinute)
                }
                
                Section(header: Text("Optional")) {
                    TextField("Location", text: $viewModel.location)
                    
                    TextEditor(text: $viewModel.notes)
                        .frame(height: 100)
                }
            }
            .navigationTitle("Edit Event")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancel") {
                        if viewModel.hasChanges {
                            viewModel.showCancelConfirmation = true
                        } else {
                            dismiss()
                        }
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("Save") {
                        Task {
                            await viewModel.saveChanges()
                            dismiss()
                        }
                    }
                    .disabled(!viewModel.isValid)
                }
            }
            .confirmationDialog("Discard Changes?", isPresented: $viewModel.showCancelConfirmation) {
                Button("Discard", role: .destructive) {
                    dismiss()
                }
                Button("Keep Editing", role: .cancel) {}
            }
        }
    }
}
```

---

## ðŸ—ï¸ **Technical Architecture**

### **Component Hierarchy**

```
ChatView
â”œâ”€â”€ NavigationBar
â”‚   â”œâ”€â”€ BackButton
â”‚   â”œâ”€â”€ ChatTitle
â”‚   â””â”€â”€ InfoButton â† NEW
â”‚       â””â”€â”€ Badge (if active events > 0)
â”‚
â””â”€â”€ Sheet: EventsListView â† NEW
    â”œâ”€â”€ NavigationBar ("Events", "Done")
    â”œâ”€â”€ List
    â”‚   â”œâ”€â”€ Section: "Upcoming"
    â”‚   â”‚   â””â”€â”€ ForEach(upcomingEvents)
    â”‚   â”‚       â””â”€â”€ EventRowView
    â”‚   â””â”€â”€ Section: "Past"
    â”‚       â””â”€â”€ ForEach(pastEvents)
    â”‚           â””â”€â”€ EventRowView
    â”‚
    â””â”€â”€ Sheet: EventDetailView â† NEW
        â”œâ”€â”€ EventInfoSection
        â”œâ”€â”€ RSVPSection
        â”œâ”€â”€ ActionsSection
        â”‚   â”œâ”€â”€ AddToCalendarButton
        â”‚   â”œâ”€â”€ EditButton (creator)
        â”‚   â”œâ”€â”€ CancelButton (creator)
        â”‚   â””â”€â”€ ChangeRSVPButton (participant)
        â”‚
        â””â”€â”€ Sheet: EventEditView â† NEW
            â””â”€â”€ Form (title, date, time, location, notes)
```

### **New Files to Create**

```
messAI/
â”œâ”€â”€ Views/
â”‚   â””â”€â”€ Events/                      â† NEW FOLDER
â”‚       â”œâ”€â”€ EventsListView.swift     (120 lines) â† Main events sheet
â”‚       â”œâ”€â”€ EventRowView.swift       (80 lines)  â† Reusable row component
â”‚       â”œâ”€â”€ EventDetailView.swift    (200 lines) â† Event detail modal
â”‚       â””â”€â”€ EventEditView.swift      (150 lines) â† Edit modal (creator)
â”‚
â”œâ”€â”€ ViewModels/
â”‚   â”œâ”€â”€ EventsListViewModel.swift    (150 lines) â† Events list logic
â”‚   â”œâ”€â”€ EventDetailViewModel.swift   (180 lines) â† Event detail logic
â”‚   â””â”€â”€ EventEditViewModel.swift     (120 lines) â† Edit logic
â”‚
â””â”€â”€ Models/
    â””â”€â”€ EventDocument.swift           (EXTEND EXISTING)
        â””â”€â”€ Add computed properties for UI
```

**Total New Code:** ~1,000 lines across 7 files

---

### **Data Flow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Actions                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€> Tap Info Button
               â”‚   â””â”€> ChatView shows EventsListView sheet
               â”‚       â””â”€> EventsListViewModel fetches events from Firestore
               â”‚           â””â”€> Display events (upcoming & past)
               â”‚
               â”œâ”€> Tap Event Row
               â”‚   â””â”€> EventsListView shows EventDetailView modal
               â”‚       â””â”€> EventDetailViewModel fetches event details
               â”‚           â””â”€> Display full event info + RSVPs
               â”‚
               â”œâ”€> Tap "Edit Event" (creator)
               â”‚   â””â”€> EventDetailView shows EventEditView modal
               â”‚       â””â”€> EventEditViewModel loads current values
               â”‚           â””â”€> User edits â†’ Tap "Save"
               â”‚               â””â”€> Update Firestore
               â”‚                   â””â”€> Firestore listener notifies all devices
               â”‚                       â”œâ”€> Update EventDetailView
               â”‚                       â”œâ”€> Update EventsListView
               â”‚                       â”œâ”€> Update Ambient Bars
               â”‚                       â””â”€> Send system message to chat
               â”‚
               â”œâ”€> Tap "Cancel Event" (creator)
               â”‚   â””â”€> Show confirmation dialog
               â”‚       â””â”€> Confirm â†’ Update event.status = "cancelled"
               â”‚           â””â”€> Firestore listener notifies all devices
               â”‚               â”œâ”€> Dismiss all Ambient Bars
               â”‚               â”œâ”€> Update EventDetailView
               â”‚               â”œâ”€> Update EventsListView
               â”‚               â””â”€> Send system message to chat
               â”‚
               â”œâ”€> Tap "Add to Calendar"
               â”‚   â””â”€> Create EKEvent
               â”‚       â””â”€> Open iOS Calendar with event
               â”‚           â””â”€> User confirms â†’ Event added to Calendar
               â”‚
               â””â”€> Tap "Change Response" (participant)
                   â””â”€> Show action sheet (Yes/No/Maybe)
                       â””â”€> Select option â†’ Update Firestore
                           â””â”€> Firestore listener notifies all devices
                               â”œâ”€> Update EventDetailView (RSVP list)
                               â”œâ”€> Update Ambient Bars (RSVP count)
                               â””â”€> No chat message (silent update)
```

---

### **Firestore Queries**

**1. Fetch All Events for Conversation:**
```swift
// In EventsListViewModel
func loadEvents() async {
    let db = Firestore.firestore()
    
    do {
        let snapshot = try await db.collection("events")
            .whereField("conversationId", isEqualTo: conversationId)
            .order(by: "date", descending: false)  // Oldest first
            .getDocuments()
        
        let allEvents = try snapshot.documents.compactMap { doc in
            try doc.data(as: EventDocument.self)
        }
        
        // Split into upcoming and past
        let now = Date()
        upcomingEvents = allEvents.filter { $0.eventDate >= now && $0.status != "cancelled" }
        pastEvents = allEvents.filter { $0.eventDate < now || $0.status == "cancelled" }
        
    } catch {
        print("âŒ Failed to load events: \(error)")
    }
}
```

**2. Listen to Single Event:**
```swift
// In EventDetailViewModel
func startListening(to eventId: String) {
    let db = Firestore.firestore()
    
    listener = db.collection("events").document(eventId)
        .addSnapshotListener { [weak self] snapshot, error in
            guard let self = self else { return }
            
            if let error = error {
                print("âŒ Event listener error: \(error)")
                return
            }
            
            guard let data = snapshot?.data() else { return }
            
            do {
                let updatedEvent = try snapshot!.data(as: EventDocument.self)
                
                Task { @MainActor in
                    self.event = updatedEvent
                    self.fetchDisplayNames()
                }
                
            } catch {
                print("âŒ Failed to parse event: \(error)")
            }
        }
}
```

**3. Update Event:**
```swift
// In EventEditViewModel
func saveChanges() async throws {
    let db = Firestore.firestore()
    
    let updates: [String: Any] = [
        "title": title,
        "date": dateString,
        "time": timeString,
        "location": location,
        "notes": notes,
        "updatedAt": FieldValue.serverTimestamp()
    ]
    
    try await db.collection("events").document(eventId).updateData(updates)
    
    // Send system message to chat
    await sendSystemMessage("Updated \(title): New time is \(timeString)")
}
```

**4. Cancel Event:**
```swift
// In EventDetailViewModel
func cancelEvent() async {
    let db = Firestore.firestore()
    
    do {
        try await db.collection("events").document(event.id).updateData([
            "status": "cancelled",
            "cancelledAt": FieldValue.serverTimestamp(),
            "cancelledBy": currentUserId
        ])
        
        // Send system message
        await sendSystemMessage("Cancelled \(event.title)")
        
    } catch {
        print("âŒ Failed to cancel event: \(error)")
    }
}
```

---

## ðŸ“¦ **Data Models**

### **Extended EventDocument Model**

**Existing Fields (from PR#20.1):**
```swift
struct EventDocument: Identifiable, Codable {
    let id: String
    let title: String
    let conversationId: String
    let createdBy: String
    let date: String           // "October 31" or "Monday"
    let time: String           // "7PM"
    let location: String?
    let participants: [String]
    let createdAt: Date
    let updatedAt: Date
    let status: String         // "pending", "confirmed", "cancelled"
    var rsvps: [String: String]  // userId -> "yes"/"no"/"maybe"
}
```

**NEW: Computed Properties for UI:**
```swift
extension EventDocument {
    // MARK: - UI Computed Properties
    
    /// Formatted date for display (e.g., "October 31, 2025")
    var formattedDate: String {
        // Parse date string and format nicely
        // Handle "Monday", "October 31", "tomorrow", etc.
    }
    
    /// Formatted time for display (e.g., "7:00 PM")
    var formattedTime: String {
        // Parse time string and format nicely
        // Handle "7PM", "19:00", "2:30PM", etc.
    }
    
    /// Actual Date object for sorting/comparing
    var eventDate: Date {
        // Parse date + time into Date object
        // Use current year if not specified
    }
    
    /// Event icon (emoji)
    var icon: String {
        // Derive from title or eventType
        // "Birthday Party" -> ðŸŽ‚
        // "Swimming" -> ðŸŠ
        // "Soccer" -> âš½
        // Default -> ðŸ“…
    }
    
    /// Is this event in the future?
    var isUpcoming: Bool {
        return eventDate >= Date() && status != "cancelled"
    }
    
    /// Is this event cancelled?
    var isCancelled: Bool {
        return status == "cancelled"
    }
    
    /// RSVP summary text (e.g., "3 going, 1 can't, 2 pending")
    var rsvpSummary: String {
        let yes = rsvps.values.filter { $0 == "yes" }.count
        let no = rsvps.values.filter { $0 == "no" }.count
        let maybe = rsvps.values.filter { $0 == "maybe" }.count
        let pending = participants.count - rsvps.count
        
        var parts: [String] = []
        if yes > 0 { parts.append("\(yes) going") }
        if no > 0 { parts.append("\(no) can't") }
        if maybe > 0 { parts.append("\(maybe) maybe") }
        if pending > 0 { parts.append("\(pending) pending") }
        
        return parts.joined(separator: ", ")
    }
    
    /// Creator text for UI (e.g., "Created by John" or "You created this event")
    func creatorText(currentUserId: String) -> String {
        if createdBy == currentUserId {
            return "You created this event"
        } else {
            // Fetch display name asynchronously
            return "Created by [User]"  // Placeholder
        }
    }
}
```

### **RSVP Response Enum**

```swift
enum RSVPResponse: String {
    case yes
    case no
    case maybe
    case pending  // Not responded yet
    
    var icon: String {
        switch self {
        case .yes: return "checkmark.circle.fill"
        case .no: return "xmark.circle.fill"
        case .maybe: return "questionmark.circle.fill"
        case .pending: return "clock.fill"
        }
    }
    
    var color: Color {
        switch self {
        case .yes: return .green
        case .no: return .red
        case .maybe: return .yellow
        case .pending: return .gray
        }
    }
    
    var backgroundColor: Color {
        return color.opacity(0.1)
    }
}
```

---

## ðŸŽ¯ **Implementation Strategy**

### **Phase 1: Basic Infrastructure** (2-3 hours)

**Goal:** Info button â†’ Events List â†’ Event Detail (read-only)

**Steps:**
1. Add Info button to ChatView header
2. Create `EventsListView.swift` (empty state)
3. Create `EventsListViewModel.swift` (fetch events query)
4. Create `EventRowView.swift` (event row component)
5. Create `EventDetailView.swift` (read-only details)
6. Create `EventDetailViewModel.swift` (fetch event, listen to changes)
7. Test: View all events, tap to see details

**Success Criteria:**
- âœ… Info button appears in ChatView header
- âœ… Tapping info button opens Events List sheet
- âœ… Events list shows all events (upcoming & past)
- âœ… Tapping event opens Event Detail modal
- âœ… Event details show all info (date, time, location, RSVPs)

---

### **Phase 2: Calendar Integration** (1 hour)

**Goal:** Add to Calendar button works

**Steps:**
1. Import EventKit
2. Request calendar permissions
3. Implement `addToCalendar()` in `EventDetailViewModel`
4. Create `EKEvent` from `EventDocument`
5. Open iOS Calendar with pre-filled event
6. Test: Add event to calendar, verify it appears

**Success Criteria:**
- âœ… "Add to Calendar" button works
- âœ… iOS Calendar opens with event pre-filled
- âœ… User can confirm and save to calendar
- âœ… Button shows "Added âœ“" after adding (local state)

---

### **Phase 3: RSVP Management** (1-2 hours)

**Goal:** Change RSVP for participants

**Steps:**
1. Add "Change Response" button (participants only)
2. Show action sheet with Yes/No/Maybe options
3. Implement `changeRSVP()` in `EventDetailViewModel`
4. Update Firestore `rsvps` map
5. Listen to RSVP changes, update UI
6. Test: Change RSVP, verify updates on all devices

**Success Criteria:**
- âœ… "Change Response" button shows for participants
- âœ… Action sheet shows Yes/No/Maybe options
- âœ… Selecting option updates Firestore
- âœ… Event Detail refreshes with new RSVP list
- âœ… Ambient Bar updates (if active)

---

### **Phase 4: Event Editing** (2-3 hours)

**Goal:** Creators can edit event details

**Steps:**
1. Create `EventEditView.swift` (form with all fields)
2. Create `EventEditViewModel.swift` (edit logic)
3. Add "Edit Event" button (creator only)
4. Implement `saveChanges()` (update Firestore)
5. Send system message to chat ("User2 updated Party")
6. Test: Edit event, verify updates on all devices

**Success Criteria:**
- âœ… "Edit Event" button shows for creator only
- âœ… Tapping opens edit modal with current values
- âœ… Can edit title, date, time, location, notes
- âœ… "Save" updates Firestore
- âœ… System message sent to chat
- âœ… All devices see updated event
- âœ… Ambient Bars update in real-time

---

### **Phase 5: Event Cancellation** (1 hour)

**Goal:** Creators can cancel events

**Steps:**
1. Add "Cancel Event" button (creator only, red/destructive)
2. Show confirmation dialog
3. Implement `cancelEvent()` (update status to "cancelled")
4. Dismiss all Ambient Bars (all users)
5. Send system message to chat ("User2 cancelled Party")
6. Test: Cancel event, verify all devices updated

**Success Criteria:**
- âœ… "Cancel Event" button shows for creator only
- âœ… Tapping shows confirmation dialog
- âœ… Confirming sets event.status = "cancelled"
- âœ… All Ambient Bars dismiss (all users)
- âœ… System message sent to chat
- âœ… Event still visible in Events Sheet (with "Cancelled" badge)

---

### **Phase 6: Polish & Edge Cases** (1-2 hours)

**Goal:** Handle edge cases, loading states, errors

**Steps:**
1. Add loading states (skeleton views)
2. Add empty states (no events)
3. Add error handling (network failures)
4. Add pull-to-refresh (Events List)
5. Add badge count (Info button)
6. Test all edge cases

**Success Criteria:**
- âœ… Loading states show while fetching
- âœ… Empty state shows if no events
- âœ… Error messages show if network fails
- âœ… Pull-to-refresh works in Events List
- âœ… Badge shows count of active events

---

## âš ï¸ **Edge Cases & Error Handling**

### **Edge Case 1: No Events in Conversation**

**Scenario:** User taps Info button, but no events have been created yet.

**Expected Behavior:**
- Show empty state in Events List sheet
- Display message: "No Events Yet" with icon
- Sub-message: "Events created in this chat will appear here"

**Implementation:**
```swift
if viewModel.upcomingEvents.isEmpty && viewModel.pastEvents.isEmpty {
    ContentUnavailableView(
        "No Events Yet",
        systemImage: "calendar.badge.questionmark",
        description: Text("Events created in this chat will appear here")
    )
}
```

---

### **Edge Case 2: Event Date/Time Parsing Fails**

**Scenario:** Event has malformed date/time string (e.g., "this weekend" couldn't be parsed).

**Expected Behavior:**
- Show original string as-is (don't crash)
- Sort to bottom of list (treat as unknown date)
- Show warning icon in Event Detail

**Implementation:**
```swift
var eventDate: Date {
    // Try to parse date string
    if let parsed = parseDate(date, time: time) {
        return parsed
    }
    // Fallback: return distant past (sorts to bottom)
    return Date.distantPast
}

var formattedDate: String {
    if eventDate == .distantPast {
        return "\(date) (date unclear)"  // Show original + warning
    }
    return DateFormatter.localizedString(from: eventDate, dateStyle: .medium, timeStyle: .none)
}
```

---

### **Edge Case 3: User Not in Conversation Anymore**

**Scenario:** User was removed from group chat but event still exists.

**Expected Behavior:**
- Show message: "You are no longer in this conversation"
- Disable all actions (can't RSVP, edit, etc.)
- Still allow viewing event (read-only)

**Implementation:**
```swift
// In EventDetailViewModel
var canInteract: Bool {
    return conversation.participantIds.contains(currentUserId)
}

// In UI
if !viewModel.canInteract {
    Text("You are no longer in this conversation")
        .foregroundColor(.secondary)
        .padding()
}
```

---

### **Edge Case 4: Event Creator Leaves Conversation**

**Scenario:** User who created event leaves the group chat.

**Expected Behavior:**
- Event still exists (don't delete)
- No one can edit event (creator gone)
- Participants can still RSVP
- Show "Created by [User] (left)" in Event Detail

**Implementation:**
```swift
func creatorText(currentUserId: String, participants: [String]) -> String {
    if createdBy == currentUserId {
        return "You created this event"
    }
    
    let creatorInChat = participants.contains(createdBy)
    let displayName = // fetch display name
    
    if creatorInChat {
        return "Created by \(displayName)"
    } else {
        return "Created by \(displayName) (left)"
    }
}
```

---

### **Edge Case 5: Rapid Updates (Edit Spam)**

**Scenario:** Creator rapidly edits event multiple times (poor network, accidental taps).

**Expected Behavior:**
- Debounce updates (max 1 update per 2 seconds)
- Show loading indicator while saving
- Disable "Save" button after tap (prevent double-tap)
- If save fails, show error and allow retry

**Implementation:**
```swift
// In EventEditViewModel
@Published var isSaving = false
private var lastSaveTime: Date?

func saveChanges() async throws {
    // Debounce (prevent rapid saves)
    if let lastSave = lastSaveTime, Date().timeIntervalSince(lastSave) < 2.0 {
        print("âš ï¸ Save debounced (too soon)")
        return
    }
    
    isSaving = true
    defer { isSaving = false }
    
    do {
        try await updateFirestore()
        lastSaveTime = Date()
    } catch {
        // Show error to user
        errorMessage = "Failed to save: \(error.localizedDescription)"
        throw error
    }
}
```

---

### **Edge Case 6: Network Failure**

**Scenario:** User tries to view events while offline.

**Expected Behavior:**
- Show cached events (if available)
- Show "Offline" indicator at top
- Disable edit/cancel actions (require network)
- Allow viewing cached data
- Auto-retry when connection restored

**Implementation:**
```swift
// In EventsListViewModel
@Published var isOffline = false
@Published var cachedEvents: [EventDocument] = []

func loadEvents() async {
    // Check network
    if !NetworkMonitor.shared.isConnected {
        isOffline = true
        // Load from cache
        events = cachedEvents
        return
    }
    
    do {
        events = try await fetchFromFirestore()
        // Cache for offline use
        cachedEvents = events
        isOffline = false
    } catch {
        // Fallback to cache
        events = cachedEvents
        isOffline = true
    }
}
```

---

### **Edge Case 7: iOS Calendar Permission Denied**

**Scenario:** User taps "Add to Calendar" but hasn't granted calendar permissions.

**Expected Behavior:**
- Request permissions (EKEventStore)
- If denied, show alert: "Calendar access required"
- Provide button to open Settings
- Don't crash or fail silently

**Implementation:**
```swift
func addToCalendar() async {
    let eventStore = EKEventStore()
    
    do {
        let granted = try await eventStore.requestFullAccessToEvents()
        
        if granted {
            // Create event and open calendar
            await createCalendarEvent(eventStore)
        } else {
            // Show permission denied alert
            showPermissionAlert = true
        }
    } catch {
        print("âŒ Calendar permission error: \(error)")
        errorMessage = "Failed to access calendar"
    }
}
```

---

### **Edge Case 8: Cancelled Event Still Shown**

**Scenario:** Event is cancelled but still appears in Events List and Ambient Bars.

**Expected Behavior:**
- Remove from "Upcoming" section
- Move to "Past" section (even if date is future)
- Show "Cancelled" badge
- Dismiss all Ambient Bars (all users)
- Disable RSVP actions (read-only)

**Implementation:**
```swift
// In EventsListViewModel
func loadEvents() async {
    let allEvents = try await fetchFromFirestore()
    
    // Filter into upcoming and past
    upcomingEvents = allEvents.filter { event in
        return event.status != "cancelled" && event.eventDate >= Date()
    }
    
    pastEvents = allEvents.filter { event in
        return event.status == "cancelled" || event.eventDate < Date()
    }
}
```

---

## ðŸ§ª **Testing Strategy**

### **Unit Tests**

**1. Date/Time Parsing:**
```swift
func testDateParsing() {
    let event = EventDocument(date: "October 31", time: "7PM")
    XCTAssertNotNil(event.eventDate)
    XCTAssertEqual(event.formattedDate, "October 31, 2025")
}

func testMalformedDate() {
    let event = EventDocument(date: "invalid", time: "??")
    XCTAssertEqual(event.eventDate, .distantPast)  // Fallback
}
```

**2. RSVP Summary:**
```swift
func testRSVPSummary() {
    var event = EventDocument(participants: ["u1", "u2", "u3", "u4", "u5"])
    event.rsvps = ["u1": "yes", "u2": "yes", "u3": "no", "u4": "maybe"]
    
    XCTAssertEqual(event.rsvpSummary, "2 going, 1 can't, 1 maybe, 1 pending")
}
```

**3. Event Sorting:**
```swift
func testEventSorting() {
    let events = [
        EventDocument(date: "November 5", status: "pending"),
        EventDocument(date: "October 31", status: "pending"),
        EventDocument(date: "November 2", status: "pending")
    ]
    
    let sorted = events.sorted { $0.eventDate < $1.eventDate }
    XCTAssertEqual(sorted[0].date, "October 31")
    XCTAssertEqual(sorted[1].date, "November 2")
    XCTAssertEqual(sorted[2].date, "November 5")
}
```

---

### **Integration Tests**

**1. Fetch Events:**
```swift
func testFetchEvents() async throws {
    let viewModel = EventsListViewModel(conversationId: testConversationId)
    
    await viewModel.loadEvents()
    
    XCTAssertFalse(viewModel.upcomingEvents.isEmpty)
    XCTAssertTrue(viewModel.upcomingEvents[0].isUpcoming)
}
```

**2. Edit Event:**
```swift
func testEditEvent() async throws {
    let event = EventDocument(id: testEventId, title: "Original")
    let viewModel = EventEditViewModel(event: event)
    
    viewModel.title = "Updated"
    try await viewModel.saveChanges()
    
    // Verify Firestore updated
    let updated = try await fetchEvent(testEventId)
    XCTAssertEqual(updated.title, "Updated")
}
```

**3. Cancel Event:**
```swift
func testCancelEvent() async throws {
    let event = EventDocument(id: testEventId, status: "pending")
    let viewModel = EventDetailViewModel(event: event)
    
    await viewModel.cancelEvent()
    
    // Verify status changed
    let cancelled = try await fetchEvent(testEventId)
    XCTAssertEqual(cancelled.status, "cancelled")
}
```

---

### **UI Tests**

**1. Open Events Sheet:**
```swift
func testOpenEventsSheet() throws {
    let app = XCUIApplication()
    app.launch()
    
    // Navigate to chat
    app.tables.staticTexts["Test Chat"].tap()
    
    // Tap info button
    app.navigationBars.buttons["Info"].tap()
    
    // Verify sheet opened
    XCTAssertTrue(app.navigationBars["Events"].exists)
}
```

**2. View Event Details:**
```swift
func testViewEventDetails() throws {
    let app = XCUIApplication()
    
    // Open events sheet
    app.navigationBars.buttons["Info"].tap()
    
    // Tap first event
    app.tables.cells.element(boundBy: 0).tap()
    
    // Verify detail modal opened
    XCTAssertTrue(app.navigationBars["Event Details"].exists)
    XCTAssertTrue(app.buttons["Add to Calendar"].exists)
}
```

**3. Edit Event (Creator):**
```swift
func testEditEvent() throws {
    let app = XCUIApplication()
    
    // Navigate to event detail
    app.navigationBars.buttons["Info"].tap()
    app.tables.cells.element(boundBy: 0).tap()
    
    // Tap edit button (creator only)
    app.buttons["Edit Event"].tap()
    
    // Verify edit modal opened
    XCTAssertTrue(app.navigationBars["Edit Event"].exists)
    
    // Edit title
    let titleField = app.textFields["Event Title"]
    titleField.tap()
    titleField.typeText(" Updated")
    
    // Save
    app.navigationBars.buttons["Save"].tap()
    
    // Verify dismissed
    XCTAssertFalse(app.navigationBars["Edit Event"].exists)
}
```

---

### **Manual Testing Checklist**

**Scenario 1: View Events**
- [ ] Tap Info button â†’ Events sheet opens
- [ ] See all events (upcoming & past)
- [ ] Tap event â†’ Event detail modal opens
- [ ] See all info (date, time, location, RSVPs)
- [ ] Tap "Done" â†’ Sheet dismisses

**Scenario 2: Add to Calendar**
- [ ] Open event detail
- [ ] Tap "Add to Calendar"
- [ ] iOS Calendar opens with event
- [ ] Confirm â†’ Event added to calendar
- [ ] Button shows "Added âœ“"

**Scenario 3: Edit Event (Creator)**
- [ ] Open event detail (as creator)
- [ ] Tap "Edit Event"
- [ ] Edit title, date, time
- [ ] Tap "Save"
- [ ] Event updates on all devices
- [ ] System message appears in chat
- [ ] Ambient Bar updates

**Scenario 4: Cancel Event (Creator)**
- [ ] Open event detail (as creator)
- [ ] Tap "Cancel Event"
- [ ] See confirmation dialog
- [ ] Tap "Confirm"
- [ ] All Ambient Bars dismiss (all users)
- [ ] Event moves to "Past" section
- [ ] System message appears in chat

**Scenario 5: Change RSVP (Participant)**
- [ ] Open event detail (as participant)
- [ ] Tap "Change Response"
- [ ] See action sheet (Yes/No/Maybe)
- [ ] Select "Yes"
- [ ] RSVP list updates
- [ ] Ambient Bar updates (RSVP count)
- [ ] No chat message (silent update)

**Scenario 6: Real-Time Updates**
- [ ] Two devices, same chat
- [ ] Device 1: Edit event
- [ ] Device 2: See update immediately (<500ms)
- [ ] Both devices show same info

**Scenario 7: Offline Handling**
- [ ] Turn off network
- [ ] Open Events sheet
- [ ] See cached events
- [ ] See "Offline" indicator
- [ ] Try to edit â†’ Error message
- [ ] Turn on network
- [ ] Auto-refresh works

---

## âœ… **Success Criteria**

**Functional Requirements:**
- âœ… Info button visible in ChatView header
- âœ… Info button opens Events List sheet
- âœ… Events List shows all events (upcoming & past)
- âœ… Tapping event opens Event Detail modal
- âœ… Event Detail shows all info + RSVPs
- âœ… Creator can edit event (title, date, time, location, notes)
- âœ… Creator can cancel event (with confirmation)
- âœ… All users can add event to iOS Calendar
- âœ… Participants can change RSVP (Yes/No/Maybe)
- âœ… Real-time updates (<500ms latency)

**Non-Functional Requirements:**
- âœ… Clean, Apple-style UI (matches iOS design guidelines)
- âœ… Smooth animations (sheet transitions, updates)
- âœ… Fast performance (<100ms to open sheet)
- âœ… Handles edge cases gracefully (no crashes)
- âœ… Clear error messages (network failures, permissions)
- âœ… Accessible (VoiceOver support, dynamic type)

**Code Quality:**
- âœ… Clean MVVM architecture (separation of concerns)
- âœ… Reusable components (EventRowView, etc.)
- âœ… Comprehensive error handling (try/catch, fallbacks)
- âœ… Comprehensive logging (debug flow)
- âœ… Unit tests (date parsing, RSVP logic)
- âœ… Integration tests (Firestore CRUD)
- âœ… UI tests (user flows)

---

## ðŸ“Š **Estimated Complexity**

**Overall Complexity:** Medium-High

**Breakdown:**
- **UI Complexity:** Medium (3 new views, standard patterns)
- **Logic Complexity:** Medium (Firestore CRUD, listeners, permissions)
- **Integration Complexity:** Medium (EventKit, real-time sync)

**Risks:**
- âš ï¸ Date/time parsing (many formats to handle)
- âš ï¸ Real-time sync complexity (multiple devices)
- âš ï¸ iOS Calendar permissions (user may deny)

**Total Estimated Time:** 6-8 hours

**Timeline Breakdown:**
- Phase 1: Basic Infrastructure (2-3 hours)
- Phase 2: Calendar Integration (1 hour)
- Phase 3: RSVP Management (1-2 hours)
- Phase 4: Event Editing (2-3 hours)
- Phase 5: Event Cancellation (1 hour)
- Phase 6: Polish & Edge Cases (1-2 hours)

---

## ðŸŽ¯ **Next Steps**

**After Documentation Approval:**
1. Create branch: `feature/pr20.2-event-management`
2. Implement Phase 1 (Basic Infrastructure)
3. Test Phase 1 thoroughly
4. Implement Phase 2 (Calendar Integration)
5. Continue through all phases
6. Comprehensive testing
7. Create PR & merge

**Dependencies:**
- âœ… PR#20.1 (Proactive Agent) - COMPLETE
- âœ… Event creation via Ambient Bar - WORKING
- âœ… Firestore event documents - EXIST

**Ready to implement!** ðŸš€

